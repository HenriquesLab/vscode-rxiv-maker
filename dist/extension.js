"use strict";var xe=Object.create;var j=Object.defineProperty;var ke=Object.getOwnPropertyDescriptor;var De=Object.getOwnPropertyNames;var Ee=Object.getPrototypeOf,Se=Object.prototype.hasOwnProperty;var P=(b,e)=>j(b,"name",{value:e,configurable:!0});var Pe=(b,e)=>{for(var t in e)j(b,t,{get:e[t],enumerable:!0})},te=(b,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of De(e))!Se.call(b,s)&&s!==t&&j(b,s,{get:()=>e[s],enumerable:!(n=ke(e,s))||n.enumerable});return b};var I=(b,e,t)=>(t=b!=null?xe(Ee(b)):{},te(e||!b||!b.__esModule?j(t,"default",{value:b,enumerable:!0}):t,b)),Ce=b=>te(j({},"__esModule",{value:!0}),b);var Me={};Pe(Me,{activate:()=>Re,deactivate:()=>Ie});module.exports=Ce(Me);var l=I(require("vscode")),N=I(require("fs")),C=I(require("path")),ie=require("child_process");var O=I(require("vscode"));var M=I(require("vscode")),z=I(require("fs")),q=I(require("path"));var V=class{static{P(this,"CitationValidator")}bibEntriesCache=new Map;CACHE_DURATION=5e3;async validate(e){let t=[],s=e.getText().split(`
`);try{let i=await this.getBibEntries(e),a=new Set(i.map(o=>o.key)),r=!1;for(let o=0;o<s.length;o++){let d=s[o];if(d.trim().startsWith("```")){r=!r;continue}if(r)continue;let p=d.matchAll(/(?<!\\)\[(@[^\]]+)\]/g);for(let y of p){if(this.isPositionInCodeSpan(d,y.index))continue;let f=y[1].match(/(?<!\\)@([a-zA-Z0-9_-]+)/g);if(f)for(let S of f){let E=S.substring(1),F=d.indexOf(S,y.index);this.validateCitationKey(E,o,d,F,a,t)}}let u=d.matchAll(/(?<!\\)@(?!fig:|eq:|table:|tbl:|sfig:|stable:|snote:)([a-zA-Z0-9_-]+)/g);for(let y of u){if(this.isPositionInCodeSpan(d,y.index))continue;let f=y[1];f&&this.isValidCitationKey(f)&&this.validateCitationKey(f,o,d,y.index,a,t)}}}catch{let a=new M.Diagnostic(new M.Range(0,0,0,0),"No bibliography file (03_REFERENCES.bib) found. Citation validation disabled.",M.DiagnosticSeverity.Information);a.source="rxiv-markdown",a.code="missing-bibliography",t.push(a)}return t}validateCitationKey(e,t,n,s,i,a){if(!i.has(e)){let r=n.indexOf("@"+e,s),o=new M.Range(t,r,t,r+e.length+1),d=new M.Diagnostic(o,`Citation '@${e}' not found in bibliography`,M.DiagnosticSeverity.Error);d.source="rxiv-markdown",d.code="unknown-citation",a.push(d)}}isValidCitationKey(e){return/^[a-zA-Z0-9_-]+$/.test(e)}isPositionInCodeSpan(e,t){let n=[],s=-1;for(let i=0;i<e.length;i++)e[i]==="`"&&(s===-1?s=i:(n.push({start:s,end:i}),s=-1));for(let i of n)if(t>=i.start&&t<=i.end)return!0;return!1}async getBibEntries(e){let t=this.getBibliographySearchPaths(e),n=null;for(let a of t)try{await z.promises.access(a,z.constants.F_OK|z.constants.R_OK),n=a;break}catch{}if(!n)throw new Error("No bibliography file found");let s=this.bibEntriesCache.get(n),i=Date.now();if(s&&i-s.timestamp<this.CACHE_DURATION)return s.entries;try{let a=await z.promises.readFile(n,"utf8"),r=this.parseBibFile(a);return this.bibEntriesCache.set(n,{entries:r,timestamp:i}),r}catch(a){throw new Error(`Error reading bibliography file: ${a}`)}}getBibliographySearchPaths(e){let t=[],n=q.dirname(e.fileName);if(t.push(q.join(n,"03_REFERENCES.bib")),M.workspace.workspaceFolders)for(let s of M.workspace.workspaceFolders){let i=q.join(s.uri.fsPath,"03_REFERENCES.bib");t.includes(i)||t.push(i)}return t}parseBibFile(e){let t=[],n=/@(\w+)\s*\{\s*([^,\s]+)\s*,/g,s;for(;(s=n.exec(e))!==null;){let i=s[1],a=s[2],r=s.index,o=this.findMatchingBrace(e,r),d=e.substring(r,o),p=d.match(/title\s*=\s*[{"](.*?)["}]/),u=d.match(/author\s*=\s*[{"](.*?)["}]/),y=d.match(/year\s*=\s*[{"](.*?)["}]/);t.push({key:a,type:i,title:p?.[1],author:u?.[1],year:y?.[1]})}return t}findMatchingBrace(e,t){let n=0,s=!1,i="";for(let a=t;a<e.length;a++){let r=e[a];if(s)r===i&&e[a-1]!=="\\"&&(s=!1);else if(r==='"'||r==="'")s=!0,i=r;else if(r==="{")n++;else if(r==="}"&&(n--,n===0))return a+1}return e.length}};var A=I(require("vscode")),W=I(require("fs")),$=I(require("path"));var Y=class{static{P(this,"CrossReferenceValidator")}labelsCache=new Map;CACHE_DURATION=5e3;async validate(e){let t=[],s=e.getText().split(`
`);try{let i=await this.getDefinedLabels(e),a=this.createLabelMap(i),r={fig:/(?<!\\)@fig:([a-zA-Z0-9_-]+)/g,sfig:/(?<!\\)@sfig:([a-zA-Z0-9_-]+)/g,table:/(?<!\\)@table:([a-zA-Z0-9_-]+)/g,stable:/(?<!\\)@stable:([a-zA-Z0-9_-]+)/g,eq:/(?<!\\)@eq:([a-zA-Z0-9_-]+)/g,snote:/(?<!\\)@snote:([a-zA-Z0-9_-]+)/g},o=!1;for(let p=0;p<s.length;p++){let u=s[p];if(u.trim().startsWith("```")){o=!o;continue}if(!o)for(let[y,f]of Object.entries(r)){let S=u.matchAll(f);for(let E of S){if(this.isPositionInCodeSpan(u,E.index))continue;let F=E[1],U=`${y}:${F}`;if(!a.has(U)){let Z=new A.Range(p,E.index,p,E.index+E[0].length),B=new A.Diagnostic(Z,`Reference '${E[0]}' not found. No matching label defined.`,A.DiagnosticSeverity.Error);B.source="rxiv-markdown",B.code="undefined-reference",t.push(B)}}}}let d=this.findDuplicateLabels(i);for(let p of d)if(p.file===e.fileName){let u=new A.Range(p.line,0,p.line,0),y=new A.Diagnostic(u,`Duplicate label '${p.type}:${p.label}' defined multiple times`,A.DiagnosticSeverity.Warning);y.source="rxiv-markdown",y.code="duplicate-label",t.push(y)}}catch(i){console.error("Error validating cross-references:",i)}return t}async getDefinedLabels(e){let t=await this.getManuscriptFiles(e),n=[];for(let s of t)try{let i=this.labelsCache.get(s),a=Date.now();if(i&&a-i.timestamp<this.CACHE_DURATION){n.push(...i.labels);continue}let r=await W.promises.readFile(s,"utf8"),o=this.extractLabelsFromContent(r,s);this.labelsCache.set(s,{labels:o,timestamp:a}),n.push(...o)}catch{continue}return n}extractLabelsFromContent(e,t){let n=[],s=e.split(`
`),i={fig:/\{#fig:([a-zA-Z0-9_:-]+)([^}]*)\}/g,sfig:/\{#sfig:([a-zA-Z0-9_:-]+)([^}]*)\}/g,table:/\{#table:([a-zA-Z0-9_:-]+)([^}]*)\}/g,stable:/\{#stable:([a-zA-Z0-9_:-]+)([^}]*)\}/g,eq:/\$\$.*?\$\$\s*\{[^}]*#eq:([a-zA-Z0-9_:-]+)[^}]*\}/g,snote:/\{#snote:([a-zA-Z0-9_:-]+)\}/g};for(let a=0;a<s.length;a++){let r=s[a];for(let[o,d]of Object.entries(i)){let p=r.matchAll(d);for(let u of p){let y=u[1];n.push({type:o,label:y,line:a,file:t})}}}return n}async getManuscriptFiles(e){let t=[],n=$.dirname(e.fileName);if(t.push($.join(n,"01_MAIN.md")),t.push($.join(n,"02_SUPPLEMENTARY_INFO.md")),t.push($.join(n,"01_MAIN.rxm")),t.push($.join(n,"02_SUPPLEMENTARY_INFO.rxm")),A.workspace.workspaceFolders)for(let i of A.workspace.workspaceFolders){let a=i.uri.fsPath,r=$.join(a,"01_MAIN.md"),o=$.join(a,"02_SUPPLEMENTARY_INFO.md"),d=$.join(a,"01_MAIN.rxm"),p=$.join(a,"02_SUPPLEMENTARY_INFO.rxm");t.includes(r)||t.push(r),t.includes(o)||t.push(o),t.includes(d)||t.push(d),t.includes(p)||t.push(p)}let s=[];for(let i of t)try{await W.promises.access(i,W.constants.F_OK),s.push(i)}catch{}return s}createLabelMap(e){let t=new Map;for(let n of e){let s=`${n.type}:${n.label}`;t.set(s,n)}return t}findDuplicateLabels(e){let t=new Map,n=[];for(let s of e){let i=`${s.type}:${s.label}`;if(t.has(i)){n.push(s);let a=t.get(i);n.includes(a)||n.push(a)}else t.set(i,s)}return n}isPositionInCodeSpan(e,t){let n=[],s=-1;for(let i=0;i<e.length;i++)e[i]==="`"&&(s===-1?s=i:(n.push({start:s,end:i}),s=-1));for(let i of n)if(t>=i.start&&t<=i.end)return!0;return!1}};var k=I(require("vscode"));var H=class{static{P(this,"PythonBlockValidator")}async validate(e){let t=[],s=e.getText().split(`
`),i=!1,a=-1,r="";for(let o=0;o<s.length;o++){let d=s[o],p=d.match(/^\s*\{\{py:\s*(.*)$/),u=d.match(/^\s*\}\}\s*$/),y=d.match(/\{py:\s*([^}]+)\}/g);if(p&&!i){i=!0,a=o,r=d.match(/^\s*/)?.[0]||"";let f=p[1].trim();f&&!f.endsWith("}}")&&this.validatePythonSyntax(f,o,p.index,t)}else if(u&&i)i=!1,a=-1;else if(i&&a!==-1){let f=d.replace(/^\s*/,"");f.trim()&&!f.includes("}}")&&this.validatePythonSyntax(f,o,0,t)}if(y)for(let f of y){let S=f.match(/\{py:\s*([^}]+)\}/);if(S){let E=S[1],F=d.indexOf(f);this.validateInlinePython(E,o,F,t)}}this.validatePythonVariableOperations(d,o,t)}if(i){let o=new k.Diagnostic(new k.Range(a,0,a,s[a].length),'Unclosed Python block - missing "}}"',k.DiagnosticSeverity.Error);o.source="rxiv-markdown",o.code="unclosed-python-block",t.push(o)}return t}validatePythonSyntax(e,t,n,s){let i=e.trim();if(!i)return;let a=this.findBasicSyntaxIssues(i);for(let r of a){let o=new k.Diagnostic(new k.Range(t,n,t,n+e.length),r.message,r.severity);o.source="rxiv-markdown",o.code=r.code,s.push(o)}}validateInlinePython(e,t,n,s){let i=e.trim();if(i.includes(`
`)){let a=new k.Diagnostic(new k.Range(t,n,t,n+e.length+6),"Inline Python expressions cannot contain newlines",k.DiagnosticSeverity.Error);a.source="rxiv-markdown",a.code="multiline-inline-python",s.push(a)}this.validatePythonSyntax(i,t,n+4,s)}validatePythonVariableOperations(e,t,n){let s=[{pattern:/\{py:set\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*(.+)\}/,type:"set"},{pattern:/\{py:get\s+([a-zA-Z_][a-zA-Z0-9_]*)\}/,type:"get"},{pattern:/\{py:global\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*(.+)\}/,type:"global"},{pattern:/\{py:format="([^"]+)"\s+(.+)\}/,type:"format"},{pattern:/\{py:context="([^"]+)"\s+(.+)\}/,type:"context"},{pattern:/\{py:if\s+(.+?):\s*"([^"]*?)"\s*else:\s*"([^"]*?)"\}/,type:"conditional"}];for(let r of s){let o=e.matchAll(new RegExp(r.pattern.source,"g"));for(let d of o)this.validatePythonOperation(d,r.type,t,n)}let i=e.matchAll(/\{py:import\s+([a-zA-Z_][a-zA-Z0-9_]*(?:\.[a-zA-Z_][a-zA-Z0-9_]*)*)\}/g);for(let r of i)this.validateImportStatement(r[1],t,r.index,n);let a=e.matchAll(/\{py:from\s+([a-zA-Z_][a-zA-Z0-9_]*(?:\.[a-zA-Z_][a-zA-Z0-9_]*)*)\s+import\s+([a-zA-Z_][a-zA-Z0-9_]*(?:\s*,\s*[a-zA-Z_][a-zA-Z0-9_]*)*)\}/g);for(let r of a)this.validateFromImportStatement(r[1],r[2],t,r.index,n)}findBasicSyntaxIssues(e){let t=[],n=(e.match(/\(/g)||[]).length,s=(e.match(/\)/g)||[]).length;n!==s&&t.push({message:"Unmatched parentheses in Python code",severity:k.DiagnosticSeverity.Error,code:"unmatched-parentheses"});let i=(e.match(/\[/g)||[]).length,a=(e.match(/\]/g)||[]).length;i!==a&&t.push({message:"Unmatched brackets in Python code",severity:k.DiagnosticSeverity.Error,code:"unmatched-brackets"});let r=(e.match(/\{/g)||[]).length,o=(e.match(/\}/g)||[]).length;return r!==o&&t.push({message:"Unmatched braces in Python code",severity:k.DiagnosticSeverity.Error,code:"unmatched-braces"}),e.includes("	")&&e.includes("    ")&&t.push({message:"Mixed tabs and spaces in Python code",severity:k.DiagnosticSeverity.Warning,code:"mixed-indentation"}),e.match(/^\s*def\s+/)&&!e.includes(":")&&t.push({message:"Function definition missing colon",severity:k.DiagnosticSeverity.Error,code:"missing-colon"}),e.match(/^\s*(if|elif|else|for|while|try|except|finally|with)\s+/)&&!e.includes(":")&&t.push({message:"Control structure missing colon",severity:k.DiagnosticSeverity.Error,code:"missing-colon"}),t}validatePythonOperation(e,t,n,s){let i=e[0],a=e.index;switch(t){case"set":case"global":let r=e[1],o=e[2];if(!this.isValidVariableName(r)){let u=new k.Diagnostic(new k.Range(n,a,n,a+i.length),`Invalid variable name '${r}'`,k.DiagnosticSeverity.Error);u.source="rxiv-markdown",u.code="invalid-variable-name",s.push(u)}break;case"get":let d=e[1];if(!this.isValidVariableName(d)){let u=new k.Diagnostic(new k.Range(n,a,n,a+i.length),`Invalid variable name '${d}'`,k.DiagnosticSeverity.Error);u.source="rxiv-markdown",u.code="invalid-variable-name",s.push(u)}break;case"format":if(!e[1].trim()){let u=new k.Diagnostic(new k.Range(n,a,n,a+i.length),"Empty format specification",k.DiagnosticSeverity.Warning);u.source="rxiv-markdown",u.code="empty-format-spec",s.push(u)}break}}validateImportStatement(e,t,n,s){if(!this.isValidModuleName(e)){let i=new k.Diagnostic(new k.Range(t,n,t,n+e.length+12),`Invalid module name '${e}'`,k.DiagnosticSeverity.Error);i.source="rxiv-markdown",i.code="invalid-module-name",s.push(i)}}validateFromImportStatement(e,t,n,s,i){if(!this.isValidModuleName(e)){let r=new k.Diagnostic(new k.Range(n,s,n,s+20),`Invalid module name '${e}'`,k.DiagnosticSeverity.Error);r.source="rxiv-markdown",r.code="invalid-module-name",i.push(r)}let a=t.split(",").map(r=>r.trim());for(let r of a)if(!this.isValidVariableName(r)){let o=new k.Diagnostic(new k.Range(n,s,n,s+20),`Invalid import name '${r}'`,k.DiagnosticSeverity.Error);o.source="rxiv-markdown",o.code="invalid-import-name",i.push(o)}}isValidVariableName(e){return/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e)}isValidModuleName(e){return/^[a-zA-Z_][a-zA-Z0-9_]*(\.[a-zA-Z_][a-zA-Z0-9_]*)*$/.test(e)}};var D=I(require("vscode"));var X=class{static{P(this,"LaTeXBlockValidator")}async validate(e){let t=[],s=e.getText().split(`
`),i=!1,a=-1,r="",o=[],d=[];for(let p=0;p<s.length;p++){let u=s[p],y=u.match(/^\s*\{\{tex:\s*(.*)$/),f=u.match(/^\s*\}\}\s*$/),S=u.match(/\{\{tex:\s*([^}]+)\}\}/g);if(y&&!i){i=!0,a=p,r="",o=[];let E=y[1].trim();E&&!E.endsWith("}}")&&(r+=E+`
`,o.push(E))}else if(f&&i)i=!1,r.trim()&&this.validateTexBlock(r,a,o,d,t),this.checkUnclosedenvironments(d,p,t),d=[],a=-1,r="",o=[];else if(i&&a!==-1){let E=u.trim();E&&!E.includes("}}")&&(r+=E+`
`,o.push(E))}if(S)for(let E of S){let F=E.match(/\{\{tex:\s*([^}]+)\}\}/);if(F){let U=F[1],Z=u.indexOf(E),B=[];this.validateLaTeXSyntax(U,p,Z,B,t)}}i||this.validateInlineLaTeXElements(u,p,t)}if(i){let p=new D.Diagnostic(new D.Range(a,0,a,s[a].length),'Unclosed TeX block - missing "}}"',D.DiagnosticSeverity.Error);p.source="rxiv-markdown",p.code="unclosed-tex-block",t.push(p)}return t}validateTexBlock(e,t,n,s,i){let a=this.findBraceIssues(e);for(let r of a){let o=new D.Diagnostic(new D.Range(t,0,t+n.length,0),r.message,r.severity);o.source="rxiv-markdown",o.code=r.code,i.push(o)}for(let r=0;r<n.length;r++){let o=n[r],d=t+r+(t===0?0:1);this.trackLaTeXEnvironments(o,d,s,i)}}findBraceIssues(e){let t=[],n=0,s=!1,i="";for(let a=0;a<e.length;a++){let r=e[a],o=a>0?e[a-1]:"";if(s){r===i&&o!=="\\"&&(s=!1);continue}if((r==='"'||r==="'")&&o!=="\\"){s=!0,i=r;continue}if(r==="{"&&o!=="\\"?n++:r==="}"&&o!=="\\"&&n--,n<0){t.push({message:"Unmatched closing brace in LaTeX code",severity:D.DiagnosticSeverity.Error,code:"unmatched-closing-brace"});break}}return n>0&&t.push({message:"Unmatched opening brace in LaTeX code",severity:D.DiagnosticSeverity.Error,code:"unmatched-opening-brace"}),t}validateLaTeXSyntax(e,t,n,s,i){if(!e.trim())return;this.trackLaTeXEnvironments(e,t,s,i);let a=this.findLaTeXSyntaxIssues(e);for(let r of a){let o=new D.Diagnostic(new D.Range(t,n+r.column,t,n+r.column+r.length),r.message,r.severity);o.source="rxiv-markdown",o.code=r.code,i.push(o)}}validateInlineLaTeXElements(e,t,n){let s=[...e.matchAll(/\$\$([^$]+)\$\$/g),...e.matchAll(/(?<!\$)\$([^$\n]+)\$(?!\$)/g)];for(let a of s){let r=a[1],o=a.index,d=this.findMathExpressionIssues(r);for(let p of d){let u=new D.Diagnostic(new D.Range(t,o,t,o+a[0].length),p.message,p.severity);u.source="rxiv-markdown",u.code=p.code,n.push(u)}}let i=e.matchAll(/\\([a-zA-Z]+)(\*?)\{([^}]*)\}/g);for(let a of i){let r=a[1],o=a[2],d=a[3],p=a.index;this.validateLaTeXCommand(r,o,d,t,p,n)}}trackLaTeXEnvironments(e,t,n,s){let i=[...e.matchAll(/\\begin\{([^}]+)\}/g)],a=[...e.matchAll(/\\end\{([^}]+)\}/g)],r=[...i.map(o=>({type:"begin",env:o[1],index:o.index})),...a.map(o=>({type:"end",env:o[1],index:o.index}))].sort((o,d)=>o.index-d.index);for(let o of r)if(o.type==="begin")n.push({name:o.env,line:t});else if(o.type==="end")if(n.length===0){let d=new D.Diagnostic(new D.Range(t,o.index,t,o.index+`\\end{${o.env}}`.length),`Unexpected \\end{${o.env}} - no matching \\begin`,D.DiagnosticSeverity.Error);d.source="rxiv-markdown",d.code="unmatched-end-environment",s.push(d)}else{let d=n.pop();if(d.name!==o.env){let p=new D.Diagnostic(new D.Range(t,o.index,t,o.index+`\\end{${o.env}}`.length),`Environment mismatch: \\end{${o.env}} does not match \\begin{${d.name}} on line ${d.line+1}`,D.DiagnosticSeverity.Error);p.source="rxiv-markdown",p.code="mismatched-environment",s.push(p)}}}checkUnclosedenvironments(e,t,n){for(let s of e){let i=new D.Diagnostic(new D.Range(s.line,0,s.line,0),`Unclosed LaTeX environment '${s.name}' - missing \\end{${s.name}}`,D.DiagnosticSeverity.Error);i.source="rxiv-markdown",i.code="unclosed-environment",n.push(i)}}findLaTeXSyntaxIssues(e){let t=[];if(!e.includes(`
`)){let i=0,a=-1;for(let r=0;r<e.length;r++){let o=e[r];o==="{"&&(r===0||e[r-1]!=="\\")?(i++,i===1&&(a=r)):o==="}"&&(r===0||e[r-1]!=="\\")&&i--}i>0?t.push({message:"Unmatched opening brace in LaTeX code",severity:D.DiagnosticSeverity.Error,code:"unmatched-brace",column:a,length:1}):i<0&&t.push({message:"Unmatched closing brace in LaTeX code",severity:D.DiagnosticSeverity.Error,code:"unmatched-brace",column:0,length:e.length})}let s=e.match(/\\[0-9]/g);if(s)for(let i of s){let a=e.indexOf(i);t.push({message:`Invalid LaTeX command '${i}' - commands cannot start with numbers`,severity:D.DiagnosticSeverity.Error,code:"invalid-command",column:a,length:i.length})}return e.endsWith("\\")&&!e.endsWith("\\\\")&&t.push({message:"Incomplete LaTeX command at end of line",severity:D.DiagnosticSeverity.Error,code:"incomplete-command",column:e.length-1,length:1}),t}findMathExpressionIssues(e){let t=[];e.trim()||t.push({message:"Empty math expression",severity:D.DiagnosticSeverity.Warning,code:"empty-math"});let n=(e.match(/\\left[(\[\{|]/g)||[]).length,s=(e.match(/\\right[)\]\}|]/g)||[]).length;return n!==s&&t.push({message:"Unbalanced \\left and \\right delimiters in math expression",severity:D.DiagnosticSeverity.Error,code:"unbalanced-delimiters"}),t}validateLaTeXCommand(e,t,n,s,i,a){if(["textbf","textit","emph","caption","label"].includes(e)&&!n.trim()){let o=new D.Diagnostic(new D.Range(s,i,s,i+`\\${e}${t}{}`.length),`LaTeX command '\\${e}${t}' should not be empty`,D.DiagnosticSeverity.Warning);o.source="rxiv-markdown",o.code="empty-command-content",a.push(o)}if(e==="label"&&!n.match(/^(fig|table|eq|sfig|stable|snote):[a-zA-Z0-9_-]+$/)){let o=new D.Diagnostic(new D.Range(s,i,s,i+`\\label{${n}}`.length),`Invalid label format '${n}'. Expected format: type:name (e.g., fig:my-figure)`,D.DiagnosticSeverity.Warning);o.source="rxiv-markdown",o.code="invalid-label-format",a.push(o)}}};var w=I(require("vscode")),L=I(require("fs")),T=I(require("path"));var K=class{static{P(this,"StructureValidator")}async validate(e){let t=[],n=e.getText(),s=n.split(`
`);return await this.validateDocumentStructure(e,t),this.validateHeadingStructure(s,e,t),this.checkRequiredElements(n,e.fileName,t),await this.validateFigureFiles(s,e,t),await this.checkOrphanedElements(n,e,t),t}async validateDocumentStructure(e,t){let n=T.basename(e.fileName),s=T.dirname(e.fileName),i=[{name:"00_CONFIG.yml",description:"Configuration file"},{name:"03_REFERENCES.bib",description:"Bibliography file"}];for(let r of i){let o=T.join(s,r.name);try{await L.promises.access(o,L.constants.F_OK)}catch{if(n==="01_MAIN.md"||n==="01_MAIN.rxm"||n==="02_SUPPLEMENTARY_INFO.md"||n==="02_SUPPLEMENTARY_INFO.rxm"){let d=new w.Diagnostic(new w.Range(0,0,0,0),`Missing required file: ${r.name} (${r.description})`,w.DiagnosticSeverity.Warning);d.source="rxiv-markdown",d.code="missing-required-file",t.push(d)}}}let a=e.getText();if(a.includes("FIGURES/")||a.includes("![")){let r=T.join(s,"FIGURES");try{if(!(await L.promises.stat(r)).isDirectory()){let d=new w.Diagnostic(new w.Range(0,0,0,0),"FIGURES should be a directory, not a file",w.DiagnosticSeverity.Error);d.source="rxiv-markdown",d.code="invalid-figures-path",t.push(d)}}catch{let o=new w.Diagnostic(new w.Range(0,0,0,0),"FIGURES directory not found. Create it to store figure files.",w.DiagnosticSeverity.Information);o.source="rxiv-markdown",o.code="missing-figures-directory",t.push(o)}}}validateHeadingStructure(e,t,n){let s=0,i=!1;for(let o=0;o<e.length;o++){let d=e[o],p=d.match(/^(#{1,6})\s+(.+)$/);if(p){let u=p[1].length,y=p[2].trim();if(!i&&u===1&&(i=!0),!y){let f=new w.Diagnostic(new w.Range(o,0,o,d.length),"Empty heading - headings should have descriptive text",w.DiagnosticSeverity.Warning);f.source="rxiv-markdown",f.code="empty-heading",n.push(f)}if(u>s+1&&s>0){let f=new w.Diagnostic(new w.Range(o,0,o,p[1].length),`Heading level skipped. Level ${u} follows level ${s}. Consider using level ${s+1} instead.`,w.DiagnosticSeverity.Information);f.source="rxiv-markdown",f.code="heading-level-skip",n.push(f)}if(s=u,y.endsWith(".")){let f=new w.Diagnostic(new w.Range(o,d.lastIndexOf("."),o,d.length),"Headings typically should not end with periods",w.DiagnosticSeverity.Information);f.source="rxiv-markdown",f.code="heading-period",n.push(f)}}}let a=T.basename(t.fileName);if(!i&&!(a==="02_SUPPLEMENTARY_INFO.md"||a==="02_SUPPLEMENTARY_INFO.rxm")){let o=new w.Diagnostic(new w.Range(0,0,0,0),"Document should start with a main title (# Title)",w.DiagnosticSeverity.Information);o.source="rxiv-markdown",o.code="missing-title",n.push(o)}}checkRequiredElements(e,t,n){let s=T.basename(t);if(s==="01_MAIN.md"||s==="01_MAIN.rxm"){let i=/!\[.*?\]\(.*?\)/.test(e)||/@fig:/.test(e),a=/@table:/.test(e)||e.includes("|")||e.includes("\\begin{table}");if(!i&&!a){let o=new w.Diagnostic(new w.Range(0,0,0,0),"Main manuscript typically should include figures or tables",w.DiagnosticSeverity.Information);o.source="rxiv-markdown",o.code="missing-figures-tables",n.push(o)}if(!(/@[a-zA-Z]/.test(e)&&!e.match(/@(fig|table|eq|sfig|stable|snote):/))){let o=new w.Diagnostic(new w.Range(0,0,0,0),"Main manuscript should typically include citations",w.DiagnosticSeverity.Information);o.source="rxiv-markdown",o.code="missing-citations",n.push(o)}}if((s==="01_MAIN.md"||s==="01_MAIN.rxm")&&e.length>1e3&&!/^#+\s*(abstract|summary)/mi.test(e)){let a=new w.Diagnostic(new w.Range(0,0,0,0),"Consider adding an Abstract section to your manuscript",w.DiagnosticSeverity.Information);a.source="rxiv-markdown",a.code="missing-abstract",n.push(a)}}async validateFigureFiles(e,t,n){let s=T.dirname(t.fileName);for(let i=0;i<e.length;i++){let r=e[i].matchAll(/!\[([^\]]*)\]\(([^)]+)\)/g);for(let o of r){let d=o[1],p=o[2];if(p.startsWith("http://")||p.startsWith("https://"))continue;let u=T.resolve(s,p);try{await L.promises.access(u,L.constants.F_OK)}catch{let S=o.index+o[0].indexOf(p),E=new w.Diagnostic(new w.Range(i,S,i,S+p.length),`Figure file not found: ${p}`,w.DiagnosticSeverity.Error);E.source="rxiv-markdown",E.code="missing-figure-file",n.push(E)}let y=T.extname(p).toLowerCase(),f=[".png",".jpg",".jpeg",".pdf",".svg"];if(y&&!f.includes(y)){let S=o.index+o[0].indexOf(p),E=new w.Diagnostic(new w.Range(i,S,i,S+p.length),`Consider using recommended figure formats: ${f.join(", ")}`,w.DiagnosticSeverity.Information);E.source="rxiv-markdown",E.code="non-recommended-format",n.push(E)}}}}async checkOrphanedElements(e,t,n){let s=e.split(`
`),i=new Set,a=/\{#(s?(?:fig|table|eq|snote)):([a-zA-Z0-9_-]+)[^}]*\}/g,r;for(;(r=a.exec(e))!==null;){let d=r[1],p=r[2];i.add(`${d}:${p}`)}let o=await this.findAllReferencesInProject(t);for(let d of i)if(!o.has(d)){let p=e.match(new RegExp(`\\{#${d.replace(":",":")}[^}]*\\}`,"g"));if(p){let u=p[0],f=e.substring(0,e.indexOf(u)).split(`
`).length-1,S=new w.Diagnostic(new w.Range(f,0,f,s[f]?.length||0),`Label '${d}' is defined but never referenced in project`,w.DiagnosticSeverity.Information);S.source="rxiv-markdown",S.code="orphaned-label",n.push(S)}}this.checkUnusualPatterns(s,n)}async findAllReferencesInProject(e){let t=new Set,n=T.dirname(e.fileName),s=["01_MAIN.md","01_MAIN.rxm","02_SUPPLEMENTARY_INFO.md","02_SUPPLEMENTARY_INFO.rxm"],i=[];try{let a=await L.promises.readdir(n);for(let o of s)a.includes(o)&&i.push(o);let r=a.filter(o=>(o.endsWith(".rxm")||o.endsWith(".md"))&&!o.startsWith(".")&&!s.includes(o)&&o!=="README.md"&&o!=="CHANGELOG.md");i.push(...r);for(let o of i){let d=T.join(n,o);try{let p=await L.promises.readFile(d,"utf8"),u=/@(stable|sfig|fig|table|eq|snote):([a-zA-Z0-9_-]+)/g,y;for(;(y=u.exec(p))!==null;){let f=y[1],S=y[2];t.add(`${f}:${S}`)}}catch{continue}}}catch{let a=e.getText(),r=/@(stable|sfig|fig|table|eq|snote):([a-zA-Z0-9_-]+)/g,o;for(;(o=r.exec(a))!==null;){let d=o[1],p=o[2];t.add(`${d}:${p}`)}}return t}checkUnusualPatterns(e,t){for(let n=0;n<e.length;n++){let s=e[n];if(n<e.length-2){let i=!s.trim(),a=!e[n+1]?.trim(),r=!e[n+2]?.trim();if(i&&a&&r){let o=new w.Diagnostic(new w.Range(n,0,n+2,0),"Multiple consecutive empty lines - consider reducing for cleaner formatting",w.DiagnosticSeverity.Information);o.source="rxiv-markdown",o.code="multiple-empty-lines",t.push(o)}}if(s.match(/\s+$/)){let i=s.search(/\s+$/),a=new w.Diagnostic(new w.Range(n,i,n,s.length),"Trailing whitespace",w.DiagnosticSeverity.Information);a.source="rxiv-markdown",a.code="trailing-whitespace",t.push(a)}}}};var G=class{static{P(this,"RxivMarkdownDiagnosticsProvider")}diagnosticCollection;validators;disposables=[];constructor(){this.diagnosticCollection=O.languages.createDiagnosticCollection("rxiv-markdown"),this.validators=[new V,new Y,new H,new X,new K],this.setupEventHandlers()}setupEventHandlers(){let e=O.workspace.onDidChangeTextDocument(async i=>{this.isRxivMarkdownDocument(i.document)&&await this.validateDocument(i.document)}),t=O.workspace.onDidSaveTextDocument(async i=>{this.isRxivMarkdownDocument(i)&&await this.validateDocument(i)}),n=O.workspace.onDidOpenTextDocument(async i=>{this.isRxivMarkdownDocument(i)&&await this.validateDocument(i)}),s=O.workspace.onDidCloseTextDocument(i=>{this.isRxivMarkdownDocument(i)&&this.diagnosticCollection.delete(i.uri)});this.disposables.push(e,t,n,s)}isRxivMarkdownDocument(e){let t=e.fileName,n=t.endsWith(".rxm")||t.endsWith("01_MAIN.md")||t.endsWith("02_SUPPLEMENTARY_INFO.md");return e.languageId==="rxiv-markdown"||n}async validateDocument(e){if(this.isRxivMarkdownDocument(e))try{let t=[],n=await Promise.all(this.validators.map(s=>s.validate(e)));for(let s of n)t.push(...s);this.diagnosticCollection.set(e.uri,t)}catch(t){console.error("Error validating rxiv-markdown document:",t)}}async validateAllOpenDocuments(){let e=O.workspace.textDocuments.filter(t=>this.isRxivMarkdownDocument(t)).map(t=>this.validateDocument(t));await Promise.all(e)}clearAllDiagnostics(){this.diagnosticCollection.clear()}dispose(){this.diagnosticCollection.dispose(),this.disposables.forEach(e=>e.dispose()),this.disposables=[]}};function Re(b){console.log("Rxiv-Maker extension is now active!");let e=new G;b.subscriptions.push(e);let t=new Map,n,s=P(()=>{n&&n.dispose(),l.workspace.getConfiguration("rxiv-maker").get("showStatusBarButton",!0)&&(n=l.window.createStatusBarItem(l.StatusBarAlignment.Left,100),n.command="rxiv-maker.makePdf",n.text="\u{1F4C4} rxiv PDF",n.tooltip="Build PDF with rxiv-maker",b.subscriptions.push(n))},"createStatusBarItem"),i=P(async c=>{if(!n)return;if(c||(c=l.window.activeTextEditor?.document),!c){n.hide();return}let v=C.basename(c.fileName);if(c.fileName.endsWith(".rxm")||v==="01_MAIN.md"||v==="02_SUPPLEMENTARY_INFO.md"||c.languageId==="rxiv-markdown"){let g=l.workspace.getWorkspaceFolder(c.uri);if(g){let m=g.uri.fsPath,x=t.get(m);x===void 0&&(x=await ee(m),t.set(m,x)),x?n.show():n.hide()}else n.hide()}else n.hide()},"updateStatusBarVisibility");s(),l.window.onDidChangeActiveTextEditor(c=>{i(c?.document)},null,b.subscriptions),l.workspace.onDidOpenTextDocument(i,null,b.subscriptions),l.workspace.onDidChangeConfiguration(c=>{c.affectsConfiguration("rxiv-maker.showStatusBarButton")&&(s(),i())},null,b.subscriptions);let a=l.workspace.onDidOpenTextDocument(async c=>{let v=C.basename(c.fileName);if(c.fileName.endsWith(".rxm")||v==="01_MAIN.md"||v==="02_SUPPLEMENTARY_INFO.md"){let g=l.workspace.getWorkspaceFolder(c.uri);if(g){let m=g.uri.fsPath,x=t.get(m);x===void 0&&(x=await ee(m),t.set(m,x)),x&&(await l.languages.setTextDocumentLanguage(c,"rxiv-markdown"),await e.validateDocument(c),await i(c))}}});setTimeout(async()=>{for(let c of l.workspace.textDocuments){let v=C.basename(c.fileName);if(c.fileName.endsWith(".rxm")||v==="01_MAIN.md"||v==="02_SUPPLEMENTARY_INFO.md"){let g=l.workspace.getWorkspaceFolder(c.uri);if(g){let m=g.uri.fsPath,x=t.get(m);x===void 0&&(x=await ee(m),t.set(m,x)),x&&(await l.languages.setTextDocumentLanguage(c,"rxiv-markdown"),await e.validateDocument(c),await i(c))}}}},500);let r=l.languages.registerCompletionItemProvider({language:"rxiv-markdown"},{async provideCompletionItems(c,v){return c.lineAt(v).text.substr(0,v.character).endsWith("@")?(await ne()).map(m=>{let x=new l.CompletionItem(m.key,l.CompletionItemKind.Reference);return x.detail=m.title||m.type,x.documentation=m.author||"",x.insertText=m.key,x}):[]}},"@"),o=l.languages.registerCompletionItemProvider({language:"rxiv-markdown"},{async provideCompletionItems(c,v){return c.lineAt(v).text.substr(0,v.character).endsWith("@")?(await Q()).map(m=>{let x=m.supplementary?`s${m.type}:`:`${m.type}:`,R=new l.CompletionItem(`${x}${m.label}`,l.CompletionItemKind.Reference);return R.detail=`${m.type.toUpperCase()} reference`,R.documentation=`Line ${m.line+1}${m.supplementary?" (Supplementary)":""}`,R.insertText=`${x}${m.label}`,R}):[]}},"@"),d=l.commands.registerCommand("rxiv-maker.insertCitation",async()=>{let c=await ne();if(c.length===0){let g=[],m=l.window.activeTextEditor;if(m){let R=C.dirname(m.document.fileName);g.push(C.join(R,"03_REFERENCES.bib"))}if(l.workspace.workspaceFolders)for(let R of l.workspace.workspaceFolders){let _=C.join(R.uri.fsPath,"03_REFERENCES.bib");g.includes(_)||g.push(_)}let x=`No bibliography file (03_REFERENCES.bib) found.

Searched in:
${g.join(`
`)}

Please create 03_REFERENCES.bib in the same directory as your document.`;l.window.showWarningMessage(x);return}let v=c.map(g=>({label:g.key,description:g.title||g.type,detail:g.author||""})),h=await l.window.showQuickPick(v,{placeHolder:"Select citation to insert"});if(h){let g=l.window.activeTextEditor;if(g){let m=g.selection.active;await g.edit(x=>{x.insert(m,`@${h.label}`)})}}}),p=l.commands.registerCommand("rxiv-maker.insertFigureReference",async()=>{let v=(await Q()).filter(m=>m.type==="fig");if(v.length===0){l.window.showWarningMessage("No figure labels found in the document");return}let h=v.map(m=>({label:m.label,description:m.supplementary?"Supplementary Figure":"Figure",detail:`Line ${m.line+1}`})),g=await l.window.showQuickPick(h,{placeHolder:"Select figure reference to insert"});if(g){let m=l.window.activeTextEditor;if(m){let x=m.selection.active,R=v.find(_=>_.label===g.label)?.supplementary?"@sfig:":"@fig:";await m.edit(_=>{_.insert(x,`${R}${g.label}`)})}}}),u=l.commands.registerCommand("rxiv-maker.insertTableReference",async()=>{let v=(await Q()).filter(m=>m.type==="table");if(v.length===0){l.window.showWarningMessage("No table labels found in the document");return}let h=v.map(m=>({label:m.label,description:m.supplementary?"Supplementary Table":"Table",detail:`Line ${m.line+1}`})),g=await l.window.showQuickPick(h,{placeHolder:"Select table reference to insert"});if(g){let m=l.window.activeTextEditor;if(m){let x=m.selection.active,R=v.find(_=>_.label===g.label)?.supplementary?"@stable:":"@table:";await m.edit(_=>{_.insert(x,`${R}${g.label}`)})}}}),y=l.commands.registerCommand("rxiv-maker.insertEquationReference",async()=>{let v=(await Q()).filter(m=>m.type==="eq");if(v.length===0){l.window.showWarningMessage("No equation labels found in the document");return}let h=v.map(m=>({label:m.label,description:"Equation",detail:`Line ${m.line+1}`})),g=await l.window.showQuickPick(h,{placeHolder:"Select equation reference to insert"});if(g){let m=l.window.activeTextEditor;if(m){let x=m.selection.active;await m.edit(R=>{R.insert(x,`@eq:${g.label}`)})}}}),f,S=P(c=>(f&&f.exitStatus===void 0||(f=l.window.createTerminal({name:"rxiv-maker",cwd:c}),l.window.onDidCloseTerminal(v=>{v===f&&(f=void 0)})),f),"getRxivMakerTerminal"),E=l.commands.registerCommand("rxiv-maker.makeValidate",async()=>{let c=await J();if(!c.success||!c.manuscriptPath){l.window.showErrorMessage(c.error||"Could not determine manuscript folder");return}let v=S(c.manuscriptPath);v.show(),v.sendText("rxiv validate .")}),F=l.commands.registerCommand("rxiv-maker.makePdf",async()=>{let c=await J();if(!c.success||!c.manuscriptPath){l.window.showErrorMessage(c.error||"Could not determine manuscript folder");return}let v=S(c.manuscriptPath);v.show(),v.sendText("rxiv pdf .")}),U=l.commands.registerCommand("rxiv-maker.makeClean",async()=>{let c=await J();if(!c.success||!c.manuscriptPath){l.window.showErrorMessage(c.error||"Could not determine manuscript folder");return}let v=S(c.manuscriptPath);v.show(),v.sendText("rxiv clean .")}),Z=l.commands.registerCommand("rxiv-maker.installRxivMaker",async()=>{await l.window.withProgress({location:l.ProgressLocation.Notification,title:"Checking installation prerequisites...",cancellable:!1},async c=>{c.report({increment:50,message:"Checking pipx availability..."});let v=!1;try{await new Promise((m,x)=>{(0,ie.exec)("pipx --version",{timeout:5e3},(R,_,Ae)=>{R||(v=!0),m()})})}catch{}if(!v){if(await l.window.showWarningMessage("pipx is required to install rxiv-maker. Would you like to see installation instructions?",{modal:!0},"Show Installation Instructions","Cancel")==="Show Installation Instructions"){let R=await l.workspace.openTextDocument({content:"# Install pipx (Python Package Manager)\n\n## macOS:\n```bash\nbrew install pipx\n```\n\n## Linux (Ubuntu/Debian):\n```bash\nsudo apt update\nsudo apt install pipx\n```\n\n## Linux (Other):\n```bash\npython3 -m pip install --user pipx\npython3 -m pipx ensurepath\n```\n\n## Windows:\n```powershell\npip install --user pipx\n```\n\nAfter installing pipx, restart VS Code and try again.",language:"markdown"});await l.window.showTextDocument(R)}return}if(await l.window.showInformationMessage("Install rxiv-maker using pipx? This will install rxiv-maker globally and make it available from any terminal.",{modal:!0},"Yes, install rxiv-maker","No, cancel")!=="Yes, install rxiv-maker")return;let g=l.window.createTerminal({name:"rxiv-maker-install"});g.show(),g.sendText('echo "Installing rxiv-maker with pipx..."'),g.sendText("pipx install rxiv-maker"),g.sendText('echo "Installation complete! You can now use rxiv commands."'),g.sendText("rxiv --version")})}),B=l.commands.registerCommand("rxiv-maker.makeAddBibliography",async()=>{let c=await J();if(!c.success||!c.manuscriptPath){l.window.showErrorMessage(c.error||"Could not determine manuscript folder");return}let v=await l.window.showInputBox({prompt:"Enter DOI to add to bibliography",placeHolder:"e.g., 10.1000/example or https://doi.org/10.1000/example",validateInput:P(m=>{if(!m)return"DOI is required";if(!/^(https?:\/\/)?(dx\.)?doi\.org\/10\.|^10\./.test(m))return"Please enter a valid DOI (e.g., 10.1000/example)"},"validateInput")});if(!v)return;let h=v.replace(/^(https?:\/\/)?(dx\.)?doi\.org\//,""),g=S(c.manuscriptPath);g.show(),g.sendText(`rxiv bibliography add --manuscript-path . ${h}`)}),se=l.commands.registerCommand("rxiv-maker.insertBlindtext",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active;await c.edit(h=>{h.insert(v,"{{blindtext}}")})}}),oe=l.commands.registerCommand("rxiv-maker.insertBlindtextParagraph",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active;await c.edit(h=>{h.insert(v,"{{Blindtext}}")})}}),ae=l.commands.registerCommand("rxiv-maker.insertPythonBlock",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=c.selection;if(h.isEmpty){let g=new l.SnippetString(`{{py:
$1
}}`);await c.insertSnippet(g,v)}else{let g=c.document.getText(h);await c.edit(m=>{m.replace(h,`{{py:
${g}
}}`)})}}}),re=l.commands.registerCommand("rxiv-maker.insertPythonInline",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=c.selection;if(h.isEmpty){let g=new l.SnippetString("{py: $1}");await c.insertSnippet(g,v)}else{let g=c.document.getText(h);await c.edit(m=>{m.replace(h,`{py: ${g}}`)})}}}),ce=l.commands.registerCommand("rxiv-maker.insertPythonImport",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=[{label:"datetime",detail:"Date and time operations"},{label:"math",detail:"Mathematical functions"},{label:"statistics",detail:"Statistical functions"},{label:"json",detail:"JSON encoder/decoder"},{label:"csv",detail:"CSV file reading/writing"},{label:"random",detail:"Generate random numbers"},{label:"collections",detail:"Specialized container datatypes"},{label:"itertools",detail:"Iterator building blocks"},{label:"functools",detail:"Higher-order functions and operations on functions"}],g=await l.window.showQuickPick(h,{placeHolder:"Select a module to import (or type a custom module name)"});if(g){let m=new l.SnippetString(`{py:import ${g.label}}`);await c.insertSnippet(m,v)}else{let m=await l.window.showInputBox({prompt:"Enter module name to import",placeHolder:"e.g., datetime"});if(m){let x=new l.SnippetString(`{py:import ${m}}`);await c.insertSnippet(x,v)}}}}),le=l.commands.registerCommand("rxiv-maker.insertPythonFromImport",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=new l.SnippetString("{py:from ${1:module} import ${2:item}}");await c.insertSnippet(h,v)}}),de=l.commands.registerCommand("rxiv-maker.insertPythonSet",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=new l.SnippetString('{py:set ${1:variable_name} = ${2:"value"}}');await c.insertSnippet(h,v)}}),me=l.commands.registerCommand("rxiv-maker.insertPythonGet",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=new l.SnippetString("{py:get ${1:variable_name}}");await c.insertSnippet(h,v)}}),pe=l.commands.registerCommand("rxiv-maker.insertPythonContext",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=new l.SnippetString('{py:context="${1:context_name}" ${2:code}}');await c.insertSnippet(h,v)}}),ve=l.commands.registerCommand("rxiv-maker.insertPythonFormat",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=[{label:"number,2",detail:"Format number with 2 decimal places"},{label:"percentage,1",detail:"Format as percentage with 1 decimal place"},{label:"currency",detail:"Format as currency"},{label:"scientific,3",detail:"Format in scientific notation with 3 decimal places"},{label:"date,%Y-%m-%d",detail:"Format date as YYYY-MM-DD"},{label:"date,%B %d, %Y",detail:'Format date as "Month DD, YYYY"'},{label:"comma",detail:"Add thousand separators"}],g=await l.window.showQuickPick(h,{placeHolder:"Select a format specification"});if(g){let m=new l.SnippetString(`{py:format="${g.label}" \${1:expression}}`);await c.insertSnippet(m,v)}else{let m=new l.SnippetString('{py:format="${1:format_spec}" ${2:expression}}');await c.insertSnippet(m,v)}}}),ge=l.commands.registerCommand("rxiv-maker.insertPythonGlobal",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=new l.SnippetString('{py:global ${1:variable_name} = ${2:"value"}}');await c.insertSnippet(h,v)}}),ue=l.commands.registerCommand("rxiv-maker.insertPythonIf",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=new l.SnippetString('{py:if ${1:condition}: "${2:true_value}" else: "${3:false_value}"}');await c.insertSnippet(h,v)}}),fe=l.commands.registerCommand("rxiv-maker.insertTexBlock",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=c.selection;if(h.isEmpty){let g=new l.SnippetString(`{{tex:
$1
}}`);await c.insertSnippet(g,v)}else{let g=c.document.getText(h);await c.edit(m=>{m.replace(h,`{{tex:
${g}
}}`)})}}}),he=l.commands.registerCommand("rxiv-maker.insertTexInline",async()=>{let c=l.window.activeTextEditor;if(c){let v=c.selection.active,h=c.selection;if(h.isEmpty){let g=new l.SnippetString("{{tex: $1}}");await c.insertSnippet(g,v)}else{let g=c.document.getText(h);await c.edit(m=>{m.replace(h,`{{tex: ${g}}}`)})}}}),we=l.commands.registerCommand("rxiv-maker.validateDocument",async()=>{let c=l.window.activeTextEditor;c?(await e.validateDocument(c.document),l.window.showInformationMessage("Document validation completed")):l.window.showWarningMessage("No active document to validate")}),be=l.commands.registerCommand("rxiv-maker.clearDiagnostics",()=>{e.clearAllDiagnostics(),l.window.showInformationMessage("All diagnostics cleared")}),ye=l.commands.registerCommand("rxiv-maker.validateAllDocuments",async()=>{await e.validateAllOpenDocuments(),l.window.showInformationMessage("All documents validated")});b.subscriptions.push(a,r,o,d,p,u,y,Z,E,F,U,B,se,oe,ae,re,ce,le,de,me,pe,ve,ge,ue,fe,he,we,be,ye)}P(Re,"activate");async function ne(){let b=[],e=l.window.activeTextEditor;if(e){let n=C.dirname(e.document.fileName),s=C.join(n,"03_REFERENCES.bib");b.push(s),console.log("Rxiv-Maker: Searching for bibliography in current document directory:",s)}if(l.workspace.workspaceFolders)for(let n of l.workspace.workspaceFolders){let s=C.join(n.uri.fsPath,"03_REFERENCES.bib");b.includes(s)||(b.push(s),console.log("Rxiv-Maker: Searching for bibliography in workspace folder:",s))}let t=null;for(let n of b)try{await N.promises.access(n,N.constants.F_OK|N.constants.R_OK),t=n,console.log("Rxiv-Maker: Found bibliography file at:",t);break}catch{console.log("Rxiv-Maker: Bibliography not found at:",n)}if(!t)return console.log("Rxiv-Maker: No bibliography file found in any search location"),[];try{let n=await N.promises.readFile(t,"utf8"),s=[],i=/@(\w+)\s*\{\s*([^,\s]+)\s*,/g,a;for(;(a=i.exec(n))!==null;){let r=a[1],o=a[2],d=a.index,p=Te(n,d),u=n.substring(d,p),y=u.match(/title\s*=\s*[{"](.*?)["}]/),f=u.match(/author\s*=\s*[{"](.*?)["}]/),S=u.match(/year\s*=\s*[{"](.*?)["}]/);s.push({key:o,type:r,title:y?.[1],author:f?.[1],year:S?.[1]})}return s}catch(n){return n.code==="ENOENT"?[]:(console.error("Error parsing bibliography:",n),[])}}P(ne,"getBibEntries");async function Q(){let b=[],e=[],t=l.window.activeTextEditor;if(t){let n=C.dirname(t.document.fileName);e.push(C.join(n,"01_MAIN.md")),e.push(C.join(n,"02_SUPPLEMENTARY_INFO.md"))}if(l.workspace.workspaceFolders)for(let n of l.workspace.workspaceFolders){let s=C.join(n.uri.fsPath,"01_MAIN.md"),i=C.join(n.uri.fsPath,"02_SUPPLEMENTARY_INFO.md");e.includes(s)||e.push(s),e.includes(i)||e.push(i)}for(let n of e)try{let i=(await N.promises.readFile(n,"utf8")).split(`
`),a=n.includes("02_SUPPLEMENTARY_INFO");for(let r=0;r<i.length;r++){let o=i[r],d=/\{#(s?)((fig|table|eq|snote)):([a-zA-Z0-9_-]+)(?:\s[^}]*)?\}/g,p;for(;(p=d.exec(o))!==null;){let u=p[1]==="s"||a,y=p[2],f=p[4];b.push({type:y,label:f,line:r,supplementary:u})}}}catch{continue}return b}P(Q,"getDocumentReferences");function Te(b,e){let t=0,n=!1,s="";for(let i=e;i<b.length;i++){let a=b[i];if(n)a===s&&b[i-1]!=="\\"&&(n=!1);else if(a==='"'||a==="'")n=!0,s=a;else if(a==="{")t++;else if(a==="}"&&(t--,t===0))return i+1}return b.length}P(Te,"findMatchingBrace");async function ee(b){try{let e=["00_CONFIG.yml","01_MAIN.rxm","01_MAIN.md","03_REFERENCES.bib"],t=["02_SUPPLEMENTARY_INFO.rxm","02_SUPPLEMENTARY_INFO.md"];return(await Promise.all(e.map(async i=>{try{return await N.promises.access(C.join(b,i)),!0}catch{return!1}}))).filter(Boolean).length>=2}catch(e){return console.error("Error checking rxiv-maker project:",e),!1}}P(ee,"isRxivMakerProject");async function J(){let b=l.window.activeTextEditor;if(!b)return{success:!1,error:"No active document. Please open a file in your manuscript folder."};let e=b.document.fileName,t=C.dirname(e),n=["00_CONFIG.yml","01_MAIN.md","01_MAIN.rxm","03_REFERENCES.bib"],s=await Promise.all(n.map(async a=>{try{return await N.promises.access(C.join(t,a)),!0}catch{return!1}})),i;if(s.some(a=>a))i=t;else{let a=l.workspace.workspaceFolders;if(!a)return{success:!1,error:"No workspace folder found. Please open the manuscript folder in VS Code."};let r=null;for(let o of a){let d=o.uri.fsPath;if((await Promise.all(n.map(async u=>{try{return await N.promises.access(C.join(d,u)),!0}catch{return!1}}))).some(u=>u)){r=d;break}}if(!r)return{success:!1,error:"No manuscript folder found. Please ensure your workspace contains a folder with rxiv-maker files (00_CONFIG.yml, 01_MAIN.md, etc.)"};i=r}return{success:!0,manuscriptPath:i}}P(J,"findManuscriptFolder");function Ie(){}P(Ie,"deactivate");0&&(module.exports={activate,deactivate});
