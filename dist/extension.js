"use strict";var Ye=Object.create;var X=Object.defineProperty;var He=Object.getOwnPropertyDescriptor;var Ke=Object.getOwnPropertyNames;var Xe=Object.getPrototypeOf,Ge=Object.prototype.hasOwnProperty;var y=(u,e)=>X(u,"name",{value:e,configurable:!0});var Qe=(u,e)=>{for(var n in e)X(u,n,{get:e[n],enumerable:!0})},me=(u,e,n,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ke(e))!Ge.call(u,s)&&s!==n&&X(u,s,{get:()=>e[s],enumerable:!(t=He(e,s))||t.enumerable});return u};var T=(u,e,n)=>(n=u!=null?Ye(Xe(u)):{},me(e||!u||!u.__esModule?X(n,"default",{value:u,enumerable:!0}):n,u)),Je=u=>me(X({},"__esModule",{value:!0}),u);var at={};Qe(at,{activate:()=>st,deactivate:()=>ot});module.exports=Je(at);var l=T(require("vscode")),z=T(require("fs")),S=T(require("path")),De=require("child_process");var W=T(require("vscode"));var L=T(require("vscode")),H=T(require("fs")),G=T(require("path"));var j=T(require("vscode"));var B=class{static{y(this,"ContentParser")}static parseDocument(e){let t=e.getText().split(`
`),s=[],i=[],o=[],a=[],r=new j.Position(0,0),d=!1,m=!1,v=null;for(let f=0;f<t.length;f++){let x=t[f],k=x.match(/^(\s*)\{\{tex:\s*(.*)$/),D=x.match(/^(\s*)\}\}\s*$/),I=x.match(/^(\s*)\{\{py:\s*(.*)$/),A=x.match(/^(\s*)\}\}\s*$/);if(k&&!d&&!m){d=!0;let O=k[1].length,M=new j.Position(f,O);if(r.isBefore(M)){let $={start:r,end:M,type:"markdown"};s.push($),a.push($)}v=M}else if(I&&!d&&!m){m=!0;let O=I[1].length,M=new j.Position(f,O);if(r.isBefore(M)){let $={start:r,end:M,type:"markdown"};s.push($),a.push($)}v=M}else if(D&&d&&v){d=!1;let O=D[1].length+2,M=new j.Position(f,O),$={start:v,end:M,type:"latex"};s.push($),i.push($),r=M,v=null}else if(A&&m&&v){m=!1;let O=A[1].length+2,M=new j.Position(f,O),$={start:v,end:M,type:"python"};s.push($),o.push($),r=M,v=null}}if(!d&&!m){let f=new j.Position(t.length,0);if(r.isBefore(f)){let x={start:r,end:f,type:"markdown"};s.push(x),a.push(x)}}return{regions:s,latexBlocks:i,pythonBlocks:o,markdownRegions:a}}static isPositionInLatexBlock(e,n){return n.latexBlocks.some(t=>this.isPositionInRegion(e,t))}static isPositionInPythonBlock(e,n){return n.pythonBlocks.some(t=>this.isPositionInRegion(e,t))}static isPositionInMarkdownRegion(e,n){return n.markdownRegions.some(t=>this.isPositionInRegion(e,t))}static rangeIntersectsLatexBlocks(e,n){return n.latexBlocks.some(t=>this.rangeIntersectsRegion(e,t))}static rangeIntersectsPythonBlocks(e,n){return n.pythonBlocks.some(t=>this.rangeIntersectsRegion(e,t))}static filterMarkdownContent(e,n,t){let s=e.split(`
`),i=[];for(let o=0;o<s.length;o++){let a=s[o],r=new j.Position(o,0),d=new j.Position(o,a.length),m=new j.Range(r,d);!this.rangeIntersectsLatexBlocks(m,t)&&!this.rangeIntersectsPythonBlocks(m,t)?i.push(a):i.push("")}return i.join(`
`)}static isPositionInRegion(e,n){return e.isAfterOrEqual(n.start)&&e.isBefore(n.end)}static rangeIntersectsRegion(e,n){return!(e.end.isBefore(n.start)||e.start.isAfterOrEqual(n.end))}};var te=class{static{y(this,"CitationValidator")}bibEntriesCache=new Map;CACHE_DURATION=5e3;async validate(e,n){let t=[],i=e.getText().split(`
`);try{let o=await this.getBibEntries(e),a=new Set(o.map(d=>d.key)),r=!1;for(let d=0;d<i.length;d++){let m=i[d];if(m.trim().startsWith("```")){r=!r;continue}if(r||n&&this.isLineInLatexBlock(d,n))continue;let v=m.matchAll(/(?<!\\)\[(@[^\]]+)\]/g);for(let x of v){if(this.isPositionInCodeSpan(m,x.index)||n&&this.isPositionInLatexBlock(d,x.index,n))continue;let k=x[1].match(/(?<!\\)@([a-zA-Z0-9_-]+)/g);if(k)for(let D of k){let I=D.substring(1),A=m.indexOf(D,x.index);this.validateCitationKey(I,d,m,A,a,t)}}let f=m.matchAll(/(?<!\\)@(?!fig:|eq:|table:|tbl:|sfig:|stable:|snote:)([a-zA-Z0-9_-]+)/g);for(let x of f){if(this.isPositionInCodeSpan(m,x.index)||n&&this.isPositionInLatexBlock(d,x.index,n))continue;let k=x[1];k&&this.isValidCitationKey(k)&&this.validateCitationKey(k,d,m,x.index,a,t)}}}catch{let a=new L.Diagnostic(new L.Range(0,0,0,0),"No bibliography file (03_REFERENCES.bib) found. Citation validation disabled.",L.DiagnosticSeverity.Information);a.source="rxiv-markdown",a.code="missing-bibliography",t.push(a)}return t}validateCitationKey(e,n,t,s,i,o){if(!i.has(e)){let a=t.indexOf("@"+e,s),r=new L.Range(n,a,n,a+e.length+1),d=new L.Diagnostic(r,`Citation '@${e}' not found in bibliography`,L.DiagnosticSeverity.Error);d.source="rxiv-markdown",d.code="unknown-citation",o.push(d)}}isValidCitationKey(e){return/^[a-zA-Z0-9_-]+$/.test(e)}isPositionInCodeSpan(e,n){let t=[],s=-1;for(let i=0;i<e.length;i++)e[i]==="`"&&(s===-1?s=i:(t.push({start:s,end:i}),s=-1));for(let i of t)if(n>=i.start&&n<=i.end)return!0;return!1}isLineInLatexBlock(e,n){let t=new L.Position(e,0);return B.isPositionInLatexBlock(t,n)}isPositionInLatexBlock(e,n,t){let s=new L.Position(e,n);return B.isPositionInLatexBlock(s,t)}async getBibEntries(e){let n=this.getBibliographySearchPaths(e),t=null;for(let o of n)try{await H.promises.access(o,H.constants.F_OK|H.constants.R_OK),t=o;break}catch{}if(!t)throw new Error("No bibliography file found");let s=this.bibEntriesCache.get(t),i=Date.now();if(s&&i-s.timestamp<this.CACHE_DURATION)return s.entries;try{let o=await H.promises.readFile(t,"utf8"),a=this.parseBibFile(o);return this.bibEntriesCache.set(t,{entries:a,timestamp:i}),a}catch(o){throw new Error(`Error reading bibliography file: ${o}`)}}getBibliographySearchPaths(e){let n=[],t=G.dirname(e.fileName);if(n.push(G.join(t,"03_REFERENCES.bib")),L.workspace.workspaceFolders)for(let s of L.workspace.workspaceFolders){let i=G.join(s.uri.fsPath,"03_REFERENCES.bib");n.includes(i)||n.push(i)}return n}parseBibFile(e){let n=[],t=/@(\w+)\s*\{\s*([^,\s]+)\s*,/g,s;for(;(s=t.exec(e))!==null;){let i=s[1],o=s[2],a=s.index,r=this.findMatchingBrace(e,a),d=e.substring(a,r),m=d.match(/title\s*=\s*[{"](.*?)["}]/),v=d.match(/author\s*=\s*[{"](.*?)["}]/),f=d.match(/year\s*=\s*[{"](.*?)["}]/);n.push({key:o,type:i,title:m?.[1],author:v?.[1],year:f?.[1]})}return n}findMatchingBrace(e,n){let t=0,s=!1,i="";for(let o=n;o<e.length;o++){let a=e[o];if(s)a===i&&e[o-1]!=="\\"&&(s=!1);else if(a==='"'||a==="'")s=!0,i=a;else if(a==="{")t++;else if(a==="}"&&(t--,t===0))return o+1}return e.length}};var U=T(require("vscode")),q=T(require("fs")),_=T(require("path"));var ne=class{static{y(this,"CrossReferenceValidator")}labelsCache=new Map;CACHE_DURATION=5e3;async validate(e,n){let t=[],i=e.getText().split(`
`);try{let o=await this.getDefinedLabels(e),a=this.createLabelMap(o),r={fig:/(?<!\\)@fig:([a-zA-Z0-9_-]+)/g,sfig:/(?<!\\)@sfig:([a-zA-Z0-9_-]+)/g,table:/(?<!\\)@table:([a-zA-Z0-9_-]+)/g,stable:/(?<!\\)@stable:([a-zA-Z0-9_-]+)/g,eq:/(?<!\\)@eq:([a-zA-Z0-9_-]+)/g,snote:/(?<!\\)@snote:([a-zA-Z0-9_-]+)/g},d=!1;for(let v=0;v<i.length;v++){let f=i[v];if(f.trim().startsWith("```")){d=!d;continue}if(!d&&!(n&&this.isLineInLatexBlock(v,n)))for(let[x,k]of Object.entries(r)){let D=f.matchAll(k);for(let I of D){if(this.isPositionInCodeSpan(f,I.index)||n&&this.isPositionInLatexBlock(v,I.index,n))continue;let A=I[1],O=`${x}:${A}`;if(!a.has(O)){let M=new U.Range(v,I.index,v,I.index+I[0].length),$=new U.Diagnostic(M,`Reference '${I[0]}' not found. No matching label defined.`,U.DiagnosticSeverity.Error);$.source="rxiv-markdown",$.code="undefined-reference",t.push($)}}}}let m=this.findDuplicateLabels(o);for(let v of m)if(v.file===e.fileName){let f=new U.Range(v.line,0,v.line,0),x=new U.Diagnostic(f,`Duplicate label '${v.type}:${v.label}' defined multiple times`,U.DiagnosticSeverity.Warning);x.source="rxiv-markdown",x.code="duplicate-label",t.push(x)}}catch(o){console.error("Error validating cross-references:",o)}return t}async getDefinedLabels(e){let n=await this.getManuscriptFiles(e),t=[];for(let s of n)try{let i=this.labelsCache.get(s),o=Date.now();if(i&&o-i.timestamp<this.CACHE_DURATION){t.push(...i.labels);continue}let a=await q.promises.readFile(s,"utf8"),r=this.extractLabelsFromContent(a,s);this.labelsCache.set(s,{labels:r,timestamp:o}),t.push(...r)}catch{continue}return t}extractLabelsFromContent(e,n){let t=[],s=e.split(`
`),i={fig:/\{#fig:([a-zA-Z0-9_:-]+)([^}]*)\}/g,sfig:/\{#sfig:([a-zA-Z0-9_:-]+)([^}]*)\}/g,table:/\{#table:([a-zA-Z0-9_:-]+)([^}]*)\}/g,stable:/\{#stable:([a-zA-Z0-9_:-]+)([^}]*)\}/g,eq:/\$\$.*?\$\$\s*\{[^}]*#eq:([a-zA-Z0-9_:-]+)[^}]*\}/g,snote:/\{#snote:([a-zA-Z0-9_:-]+)\}/g};for(let o=0;o<s.length;o++){let a=s[o];for(let[r,d]of Object.entries(i)){let m=a.matchAll(d);for(let v of m){let f=v[1];t.push({type:r,label:f,line:o,file:n})}}}return t}async getManuscriptFiles(e){let n=[],t=_.dirname(e.fileName),s=await this.findRxivMakerProjectRoot(e.fileName);if(s){let a=[_.join(s,"01_MAIN.md"),_.join(s,"02_SUPPLEMENTARY_INFO.md"),_.join(s,"01_MAIN.rxm"),_.join(s,"02_SUPPLEMENTARY_INFO.rxm")];for(let r of a)n.push(r)}let i=[_.join(t,"01_MAIN.md"),_.join(t,"02_SUPPLEMENTARY_INFO.md"),_.join(t,"01_MAIN.rxm"),_.join(t,"02_SUPPLEMENTARY_INFO.rxm")];for(let a of i)n.includes(a)||n.push(a);let o=[];for(let a of n)try{await q.promises.access(a,q.constants.F_OK),o.push(a)}catch{}return o}async findRxivMakerProjectRoot(e){let n=_.dirname(e),t=_.parse(n).root;for(;n!==t;){let s=_.join(n,"00_CONFIG.yml"),i=await this.fileExists(_.join(n,"01_MAIN.md"))||await this.fileExists(_.join(n,"01_MAIN.rxm"));if(await this.fileExists(s)&&i)return n;let o=_.dirname(n);if(o===n)break;n=o}return null}async fileExists(e){try{return await q.promises.access(e,q.constants.F_OK),!0}catch{return!1}}createLabelMap(e){let n=new Map;for(let t of e){let s=`${t.type}:${t.label}`;n.set(s,t)}return n}findDuplicateLabels(e){let n=new Map,t=[];for(let s of e){let i=`${s.type}:${s.label}`;if(n.has(i)){t.push(s);let o=n.get(i);t.includes(o)||t.push(o)}else n.set(i,s)}return t}isPositionInCodeSpan(e,n){let t=[],s=-1;for(let i=0;i<e.length;i++)e[i]==="`"&&(s===-1?s=i:(t.push({start:s,end:i}),s=-1));for(let i of t)if(n>=i.start&&n<=i.end)return!0;return!1}isLineInLatexBlock(e,n){let t=new U.Position(e,0);return B.isPositionInLatexBlock(t,n)}isPositionInLatexBlock(e,n,t){let s=new U.Position(e,n);return B.isPositionInLatexBlock(s,t)}};var P=T(require("vscode"));var se=class{static{y(this,"PythonBlockValidator")}async validate(e,n){let t=[],i=e.getText().split(`
`),o=!1,a=-1,r="";for(let d=0;d<i.length;d++){let m=i[d],v=m.match(/^\s*\{\{py:\s*(.*)$/),f=m.match(/^\s*\}\}\s*$/),x=m.match(/\{py:\s*([^}]+)\}/g);if(v&&!o){o=!0,a=d,r=m.match(/^\s*/)?.[0]||"";let k=v[1].trim();k&&!k.endsWith("}}")&&this.validatePythonSyntax(k,d,v.index,t)}else if(f&&o)o=!1,a=-1;else if(o&&a!==-1){let k=m.replace(/^\s*/,"");k.trim()&&!k.includes("}}")&&this.validatePythonSyntax(k,d,0,t)}if(x)for(let k of x){let D=k.match(/\{py:\s*([^}]+)\}/);if(D){let I=D[1],A=m.indexOf(k);this.validateInlinePython(I,d,A,t)}}this.validatePythonVariableOperations(m,d,t)}if(o){let d=new P.Diagnostic(new P.Range(a,0,a,i[a].length),'Unclosed Python block - missing "}}"',P.DiagnosticSeverity.Error);d.source="rxiv-markdown",d.code="unclosed-python-block",t.push(d)}return t}validatePythonSyntax(e,n,t,s){let i=e.trim();if(!i)return;let o=this.findBasicSyntaxIssues(i);for(let a of o){let r=new P.Diagnostic(new P.Range(n,t,n,t+e.length),a.message,a.severity);r.source="rxiv-markdown",r.code=a.code,s.push(r)}}validateInlinePython(e,n,t,s){let i=e.trim();if(i.includes(`
`)){let o=new P.Diagnostic(new P.Range(n,t,n,t+e.length+6),"Inline Python expressions cannot contain newlines",P.DiagnosticSeverity.Error);o.source="rxiv-markdown",o.code="multiline-inline-python",s.push(o)}this.validatePythonSyntax(i,n,t+4,s)}validatePythonVariableOperations(e,n,t){let s=[{pattern:/\{py:set\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*(.+)\}/,type:"set"},{pattern:/\{py:get\s+([a-zA-Z_][a-zA-Z0-9_]*)\}/,type:"get"},{pattern:/\{py:global\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*(.+)\}/,type:"global"},{pattern:/\{py:format="([^"]+)"\s+(.+)\}/,type:"format"},{pattern:/\{py:context="([^"]+)"\s+(.+)\}/,type:"context"},{pattern:/\{py:if\s+(.+?):\s*"([^"]*?)"\s*else:\s*"([^"]*?)"\}/,type:"conditional"}];for(let a of s){let r=e.matchAll(new RegExp(a.pattern.source,"g"));for(let d of r)this.validatePythonOperation(d,a.type,n,t)}let i=e.matchAll(/\{py:import\s+([a-zA-Z_][a-zA-Z0-9_]*(?:\.[a-zA-Z_][a-zA-Z0-9_]*)*)\}/g);for(let a of i)this.validateImportStatement(a[1],n,a.index,t);let o=e.matchAll(/\{py:from\s+([a-zA-Z_][a-zA-Z0-9_]*(?:\.[a-zA-Z_][a-zA-Z0-9_]*)*)\s+import\s+([a-zA-Z_][a-zA-Z0-9_]*(?:\s*,\s*[a-zA-Z_][a-zA-Z0-9_]*)*)\}/g);for(let a of o)this.validateFromImportStatement(a[1],a[2],n,a.index,t)}findBasicSyntaxIssues(e){let n=[],t=(e.match(/\(/g)||[]).length,s=(e.match(/\)/g)||[]).length;t!==s&&n.push({message:"Unmatched parentheses in Python code",severity:P.DiagnosticSeverity.Error,code:"unmatched-parentheses"});let i=(e.match(/\[/g)||[]).length,o=(e.match(/\]/g)||[]).length;i!==o&&n.push({message:"Unmatched brackets in Python code",severity:P.DiagnosticSeverity.Error,code:"unmatched-brackets"});let a=(e.match(/\{/g)||[]).length,r=(e.match(/\}/g)||[]).length;return a!==r&&n.push({message:"Unmatched braces in Python code",severity:P.DiagnosticSeverity.Error,code:"unmatched-braces"}),e.includes("	")&&e.includes("    ")&&n.push({message:"Mixed tabs and spaces in Python code",severity:P.DiagnosticSeverity.Warning,code:"mixed-indentation"}),e.match(/^\s*def\s+/)&&!e.includes(":")&&n.push({message:"Function definition missing colon",severity:P.DiagnosticSeverity.Error,code:"missing-colon"}),e.match(/^\s*(if|elif|else|for|while|try|except|finally|with)\s+/)&&!e.includes(":")&&n.push({message:"Control structure missing colon",severity:P.DiagnosticSeverity.Error,code:"missing-colon"}),n}validatePythonOperation(e,n,t,s){let i=e[0],o=e.index;switch(n){case"set":case"global":let a=e[1],r=e[2];if(!this.isValidVariableName(a)){let v=new P.Diagnostic(new P.Range(t,o,t,o+i.length),`Invalid variable name '${a}'`,P.DiagnosticSeverity.Error);v.source="rxiv-markdown",v.code="invalid-variable-name",s.push(v)}break;case"get":let d=e[1];if(!this.isValidVariableName(d)){let v=new P.Diagnostic(new P.Range(t,o,t,o+i.length),`Invalid variable name '${d}'`,P.DiagnosticSeverity.Error);v.source="rxiv-markdown",v.code="invalid-variable-name",s.push(v)}break;case"format":if(!e[1].trim()){let v=new P.Diagnostic(new P.Range(t,o,t,o+i.length),"Empty format specification",P.DiagnosticSeverity.Warning);v.source="rxiv-markdown",v.code="empty-format-spec",s.push(v)}break}}validateImportStatement(e,n,t,s){if(!this.isValidModuleName(e)){let i=new P.Diagnostic(new P.Range(n,t,n,t+e.length+12),`Invalid module name '${e}'`,P.DiagnosticSeverity.Error);i.source="rxiv-markdown",i.code="invalid-module-name",s.push(i)}}validateFromImportStatement(e,n,t,s,i){if(!this.isValidModuleName(e)){let a=new P.Diagnostic(new P.Range(t,s,t,s+20),`Invalid module name '${e}'`,P.DiagnosticSeverity.Error);a.source="rxiv-markdown",a.code="invalid-module-name",i.push(a)}let o=n.split(",").map(a=>a.trim());for(let a of o)if(!this.isValidVariableName(a)){let r=new P.Diagnostic(new P.Range(t,s,t,s+20),`Invalid import name '${a}'`,P.DiagnosticSeverity.Error);r.source="rxiv-markdown",r.code="invalid-import-name",i.push(r)}}isValidVariableName(e){return/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e)}isValidModuleName(e){return/^[a-zA-Z_][a-zA-Z0-9_]*(\.[a-zA-Z_][a-zA-Z0-9_]*)*$/.test(e)}};var E=T(require("vscode"));var ie=class{static{y(this,"LaTeXBlockValidator")}async validate(e,n){let t=[],i=e.getText().split(`
`),o=!1,a=-1,r="",d=[],m=[];for(let v=0;v<i.length;v++){let f=i[v],x=f.match(/^\s*\{\{tex:\s*(.*)$/),k=f.match(/^\s*\}\}\s*$/),D=f.match(/\{\{tex:\s*([^}]+)\}\}/g);if(x&&!o){o=!0,a=v,r="",d=[];let I=x[1].trim();I&&!I.endsWith("}}")&&(r+=I+`
`,d.push(I))}else if(k&&o)o=!1,r.trim()&&this.validateTexBlock(r,a,d,m,t),this.checkUnclosedenvironments(m,v,t),m=[],a=-1,r="",d=[];else if(o&&a!==-1){let I=f.trim();I&&(r+=I+`
`,d.push(I))}if(D)for(let I of D){let A=I.match(/\{\{tex:\s*([^}]+)\}\}/);if(A){let O=A[1],M=f.indexOf(I),$=[];this.validateLaTeXSyntax(O,v,M,$,t)}}o||this.validateInlineLaTeXElements(f,v,t)}if(o){let v=new E.Diagnostic(new E.Range(a,0,a,i[a].length),'Unclosed TeX block - missing "}}"',E.DiagnosticSeverity.Error);v.source="rxiv-markdown",v.code="unclosed-tex-block",t.push(v)}return t}validateTexBlock(e,n,t,s,i){let o=this.findBraceIssues(e);for(let a of o){let r=new E.Diagnostic(new E.Range(n,0,n+t.length,0),a.message,a.severity);r.source="rxiv-markdown",r.code=a.code,i.push(r)}for(let a=0;a<t.length;a++){let r=t[a],d=n+a+(n===0?0:1);this.trackLaTeXEnvironments(r,d,s,i)}}findBraceIssues(e){let n=[],t=0,s=!1;for(let i=0;i<e.length;i++){let o=e[i],a=i>0?e[i-1]:"";if(s){o===`
`&&(s=!1);continue}if(o==="%"&&a!=="\\"){s=!0;continue}if(o==="{"&&a!=="\\"?t++:o==="}"&&a!=="\\"&&t--,t<0){n.push({message:"Unmatched closing brace in LaTeX code",severity:E.DiagnosticSeverity.Error,code:"unmatched-closing-brace"});break}}return t>0&&n.push({message:"Unmatched opening brace in LaTeX code",severity:E.DiagnosticSeverity.Error,code:"unmatched-opening-brace"}),n}validateLaTeXSyntax(e,n,t,s,i){if(!e.trim())return;this.trackLaTeXEnvironments(e,n,s,i);let o=this.findLaTeXSyntaxIssues(e);for(let a of o){let r=new E.Diagnostic(new E.Range(n,t+a.column,n,t+a.column+a.length),a.message,a.severity);r.source="rxiv-markdown",r.code=a.code,i.push(r)}}validateInlineLaTeXElements(e,n,t){let s=[...e.matchAll(/\$\$([^$]+)\$\$/g),...e.matchAll(/(?<!\$)\$([^$\n]+)\$(?!\$)/g)];for(let o of s){let a=o[1],r=o.index,d=this.findMathExpressionIssues(a);for(let m of d){let v=new E.Diagnostic(new E.Range(n,r,n,r+o[0].length),m.message,m.severity);v.source="rxiv-markdown",v.code=m.code,t.push(v)}}let i=e.matchAll(/\\([a-zA-Z]+)(\*?)\{([^}]*)\}/g);for(let o of i){let a=o[1],r=o[2],d=o[3],m=o.index;this.validateLaTeXCommand(a,r,d,n,m,t)}}trackLaTeXEnvironments(e,n,t,s){let i=[...e.matchAll(/\\begin\{([^}]+)\}/g)],o=[...e.matchAll(/\\end\{([^}]+)\}/g)],a=[...i.map(r=>({type:"begin",env:r[1],index:r.index})),...o.map(r=>({type:"end",env:r[1],index:r.index}))].sort((r,d)=>r.index-d.index);for(let r of a)if(r.type==="begin")t.push({name:r.env,line:n});else if(r.type==="end")if(t.length===0){let d=new E.Diagnostic(new E.Range(n,r.index,n,r.index+`\\end{${r.env}}`.length),`Unexpected \\end{${r.env}} - no matching \\begin`,E.DiagnosticSeverity.Error);d.source="rxiv-markdown",d.code="unmatched-end-environment",s.push(d)}else{let d=t.pop();if(d.name!==r.env){let m=new E.Diagnostic(new E.Range(n,r.index,n,r.index+`\\end{${r.env}}`.length),`Environment mismatch: \\end{${r.env}} does not match \\begin{${d.name}} on line ${d.line+1}`,E.DiagnosticSeverity.Error);m.source="rxiv-markdown",m.code="mismatched-environment",s.push(m)}}}checkUnclosedenvironments(e,n,t){for(let s of e){let i=new E.Diagnostic(new E.Range(s.line,0,s.line,0),`Unclosed LaTeX environment '${s.name}' - missing \\end{${s.name}}`,E.DiagnosticSeverity.Error);i.source="rxiv-markdown",i.code="unclosed-environment",t.push(i)}}findLaTeXSyntaxIssues(e){let n=[];if(!e.includes(`
`)){let i=0,o=-1;for(let a=0;a<e.length;a++){let r=e[a];r==="{"&&(a===0||e[a-1]!=="\\")?(i++,i===1&&(o=a)):r==="}"&&(a===0||e[a-1]!=="\\")&&i--}i>0?n.push({message:"Unmatched opening brace in LaTeX code",severity:E.DiagnosticSeverity.Error,code:"unmatched-brace",column:o,length:1}):i<0&&n.push({message:"Unmatched closing brace in LaTeX code",severity:E.DiagnosticSeverity.Error,code:"unmatched-brace",column:0,length:e.length})}let s=e.match(/\\[0-9]/g);if(s)for(let i of s){let o=e.indexOf(i);n.push({message:`Invalid LaTeX command '${i}' - commands cannot start with numbers`,severity:E.DiagnosticSeverity.Error,code:"invalid-command",column:o,length:i.length})}return e.endsWith("\\")&&!e.endsWith("\\\\")&&n.push({message:"Incomplete LaTeX command at end of line",severity:E.DiagnosticSeverity.Error,code:"incomplete-command",column:e.length-1,length:1}),n}findMathExpressionIssues(e){let n=[];e.trim()||n.push({message:"Empty math expression",severity:E.DiagnosticSeverity.Warning,code:"empty-math"});let t=(e.match(/\\left[(\[\{|]/g)||[]).length,s=(e.match(/\\right[)\]\}|]/g)||[]).length;return t!==s&&n.push({message:"Unbalanced \\left and \\right delimiters in math expression",severity:E.DiagnosticSeverity.Error,code:"unbalanced-delimiters"}),n}validateLaTeXCommand(e,n,t,s,i,o){if(["textbf","textit","emph","caption","label"].includes(e)&&!t.trim()){let r=new E.Diagnostic(new E.Range(s,i,s,i+`\\${e}${n}{}`.length),`LaTeX command '\\${e}${n}' should not be empty`,E.DiagnosticSeverity.Warning);r.source="rxiv-markdown",r.code="empty-command-content",o.push(r)}if(e==="label"&&!t.match(/^(fig|table|eq|sfig|stable|snote):[a-zA-Z0-9_-]+$/)){let r=new E.Diagnostic(new E.Range(s,i,s,i+`\\label{${t}}`.length),`Invalid label format '${t}'. Expected format: type:name (e.g., fig:my-figure)`,E.DiagnosticSeverity.Warning);r.source="rxiv-markdown",r.code="invalid-label-format",o.push(r)}}};var b=T(require("vscode")),Z=T(require("fs")),F=T(require("path"));var oe=class{static{y(this,"StructureValidator")}async validate(e,n){let t=[],s=e.getText(),i=s.split(`
`);return await this.validateDocumentStructure(e,t),this.validateHeadingStructure(i,e,n,t),this.checkRequiredElements(s,e.fileName,n,t),await this.validateFigureFiles(i,e,t),await this.checkOrphanedElements(s,e,t),t}async validateDocumentStructure(e,n){let t=F.basename(e.fileName),s=F.dirname(e.fileName),i=[{name:"00_CONFIG.yml",description:"Configuration file"},{name:"03_REFERENCES.bib",description:"Bibliography file"}];for(let a of i){let r=F.join(s,a.name);try{await Z.promises.access(r,Z.constants.F_OK)}catch{if(t==="01_MAIN.md"||t==="01_MAIN.rxm"||t==="02_SUPPLEMENTARY_INFO.md"||t==="02_SUPPLEMENTARY_INFO.rxm"){let d=new b.Diagnostic(new b.Range(0,0,0,0),`Missing required file: ${a.name} (${a.description})`,b.DiagnosticSeverity.Warning);d.source="rxiv-markdown",d.code="missing-required-file",n.push(d)}}}let o=e.getText();if(o.includes("FIGURES/")||o.includes("![")){let a=F.join(s,"FIGURES");try{if(!(await Z.promises.stat(a)).isDirectory()){let d=new b.Diagnostic(new b.Range(0,0,0,0),"FIGURES should be a directory, not a file",b.DiagnosticSeverity.Error);d.source="rxiv-markdown",d.code="invalid-figures-path",n.push(d)}}catch{let r=new b.Diagnostic(new b.Range(0,0,0,0),"FIGURES directory not found. Create it to store figure files.",b.DiagnosticSeverity.Information);r.source="rxiv-markdown",r.code="missing-figures-directory",n.push(r)}}}validateHeadingStructure(e,n,t,s){let i=0,o=!1;for(let m=0;m<e.length;m++){let v=e[m],f=v.match(/^(#{1,6})\s+(.+)$/);if(f){if(t&&this.isLineInCodeBlock(m,t))continue;let x=f[1].length,k=f[2].trim();if(!o&&x===1&&(o=!0),!k){let D=new b.Diagnostic(new b.Range(m,0,m,v.length),"Empty heading - headings should have descriptive text",b.DiagnosticSeverity.Warning);D.source="rxiv-markdown",D.code="empty-heading",s.push(D)}if(x>i+1&&i>0){let D=new b.Diagnostic(new b.Range(m,0,m,f[1].length),`Heading level skipped. Level ${x} follows level ${i}. Consider using level ${i+1} instead.`,b.DiagnosticSeverity.Information);D.source="rxiv-markdown",D.code="heading-level-skip",s.push(D)}if(i=x,k.endsWith(".")){let D=new b.Diagnostic(new b.Range(m,v.lastIndexOf("."),m,v.length),"Headings typically should not end with periods",b.DiagnosticSeverity.Information);D.source="rxiv-markdown",D.code="heading-period",s.push(D)}}}let a=F.basename(n.fileName);if(!o&&!(a==="01_MAIN.md"||a==="01_MAIN.rxm")&&!(a==="02_SUPPLEMENTARY_INFO.md"||a==="02_SUPPLEMENTARY_INFO.rxm")){let m=new b.Diagnostic(new b.Range(0,0,0,0),"Document should start with a main title (# Title)",b.DiagnosticSeverity.Information);m.source="rxiv-markdown",m.code="missing-title",s.push(m)}}checkRequiredElements(e,n,t,s){let i=F.basename(n);if(i==="01_MAIN.md"||i==="01_MAIN.rxm"){let o=/!\[.*?\]\(.*?\)/.test(e)||/@fig:/.test(e),a=/@table:/.test(e)||e.includes("|")||e.includes("\\begin{table}");if(!o&&!a){let f=new b.Diagnostic(new b.Range(0,0,0,0),"Main manuscript typically should include figures or tables",b.DiagnosticSeverity.Information);f.source="rxiv-markdown",f.code="missing-figures-tables",s.push(f)}let r=t?B.filterMarkdownContent(e,{getText:y(()=>e,"getText"),fileName:n,languageId:"rxiv-markdown"},t):e,d=/\[@[a-zA-Z0-9_-]+(?:;@[a-zA-Z0-9_-]+)*\]/.test(r),m=/(?<![@\w])@[a-zA-Z0-9_-]+(?![:\w])/.test(r)&&!r.match(/(?<![@\w])@(fig|table|eq|sfig|stable|snote)(?![:\w])/);if(!(d||m)){let f=new b.Diagnostic(new b.Range(0,0,0,0),"Main manuscript should typically include citations",b.DiagnosticSeverity.Information);f.source="rxiv-markdown",f.code="missing-citations",s.push(f)}}if((i==="01_MAIN.md"||i==="01_MAIN.rxm")&&e.length>1e3&&!/^#+\s*(abstract|summary)/mi.test(e)){let a=new b.Diagnostic(new b.Range(0,0,0,0),"Consider adding an Abstract section to your manuscript",b.DiagnosticSeverity.Information);a.source="rxiv-markdown",a.code="missing-abstract",s.push(a)}}async validateFigureFiles(e,n,t){let s=F.dirname(n.fileName);for(let i=0;i<e.length;i++){let a=e[i].matchAll(/!\[([^\]]*)\]\(([^)]+)\)/g);for(let r of a){let d=r[1],m=r[2];if(m.startsWith("http://")||m.startsWith("https://"))continue;let v=F.resolve(s,m);try{await Z.promises.access(v,Z.constants.F_OK)}catch{let k=r.index+r[0].indexOf(m),D=new b.Diagnostic(new b.Range(i,k,i,k+m.length),`Figure file not found: ${m}`,b.DiagnosticSeverity.Error);D.source="rxiv-markdown",D.code="missing-figure-file",t.push(D)}let f=F.extname(m).toLowerCase(),x=[".png",".jpg",".jpeg",".pdf",".svg"];if(f&&!x.includes(f)){let k=r.index+r[0].indexOf(m),D=new b.Diagnostic(new b.Range(i,k,i,k+m.length),`Consider using recommended figure formats: ${x.join(", ")}`,b.DiagnosticSeverity.Information);D.source="rxiv-markdown",D.code="non-recommended-format",t.push(D)}}}}async checkOrphanedElements(e,n,t){let s=e.split(`
`),i=new Set,o=/\{#(s?(?:fig|table|eq|snote)):([a-zA-Z0-9_-]+)[^}]*\}/g,a;for(;(a=o.exec(e))!==null;){let d=a[1],m=a[2];i.add(`${d}:${m}`)}let r=await this.findAllReferencesInProject(n);for(let d of i)if(!r.has(d)){let m=e.match(new RegExp(`\\{#${d.replace(":",":")}[^}]*\\}`,"g"));if(m){let v=m[0],x=e.substring(0,e.indexOf(v)).split(`
`).length-1,k=new b.Diagnostic(new b.Range(x,0,x,s[x]?.length||0),`Label '${d}' is defined but never referenced in project`,b.DiagnosticSeverity.Information);k.source="rxiv-markdown",k.code="orphaned-label",t.push(k)}}this.checkUnusualPatterns(s,t)}async findAllReferencesInProject(e){let n=new Set,t=F.dirname(e.fileName),s=["01_MAIN.md","01_MAIN.rxm","02_SUPPLEMENTARY_INFO.md","02_SUPPLEMENTARY_INFO.rxm"],i=[];try{let o=await Z.promises.readdir(t);for(let r of s)o.includes(r)&&i.push(r);let a=o.filter(r=>(r.endsWith(".rxm")||r.endsWith(".md"))&&!r.startsWith(".")&&!s.includes(r)&&r!=="README.md"&&r!=="CHANGELOG.md");i.push(...a);for(let r of i){let d=F.join(t,r);try{let m=await Z.promises.readFile(d,"utf8"),v=/@(stable|sfig|fig|table|eq|snote):([a-zA-Z0-9_-]+)/g,f;for(;(f=v.exec(m))!==null;){let x=f[1],k=f[2];n.add(`${x}:${k}`)}}catch{continue}}}catch{let o=e.getText(),a=/@(stable|sfig|fig|table|eq|snote):([a-zA-Z0-9_-]+)/g,r;for(;(r=a.exec(o))!==null;){let d=r[1],m=r[2];n.add(`${d}:${m}`)}}return n}checkUnusualPatterns(e,n){for(let t=0;t<e.length;t++){let s=e[t];if(t<e.length-2){let i=!s.trim(),o=!e[t+1]?.trim(),a=!e[t+2]?.trim();if(i&&o&&a){let r=new b.Diagnostic(new b.Range(t,0,t+2,0),"Multiple consecutive empty lines - consider reducing for cleaner formatting",b.DiagnosticSeverity.Information);r.source="rxiv-markdown",r.code="multiple-empty-lines",n.push(r)}}if(s.match(/\s+$/)){let i=s.search(/\s+$/),o=new b.Diagnostic(new b.Range(t,i,t,s.length),"Trailing whitespace",b.DiagnosticSeverity.Information);o.source="rxiv-markdown",o.code="trailing-whitespace",n.push(o)}}}isLineInCodeBlock(e,n){let t=new b.Position(e,0);return B.isPositionInLatexBlock(t,n)||B.isPositionInPythonBlock(t,n)}};var ae=class{static{y(this,"RxivMarkdownDiagnosticsProvider")}diagnosticCollection;validators;disposables=[];constructor(){this.diagnosticCollection=W.languages.createDiagnosticCollection("rxiv-markdown"),this.validators=[new te,new ne,new se,new ie,new oe],this.setupEventHandlers()}setupEventHandlers(){let e=W.workspace.onDidChangeTextDocument(async i=>{this.isRxivMarkdownDocument(i.document)&&await this.validateDocument(i.document)}),n=W.workspace.onDidSaveTextDocument(async i=>{this.isRxivMarkdownDocument(i)&&await this.validateDocument(i)}),t=W.workspace.onDidOpenTextDocument(async i=>{this.isRxivMarkdownDocument(i)&&await this.validateDocument(i)}),s=W.workspace.onDidCloseTextDocument(i=>{this.isRxivMarkdownDocument(i)&&this.diagnosticCollection.delete(i.uri)});this.disposables.push(e,n,t,s)}isRxivMarkdownDocument(e){let n=e.fileName,t=n.endsWith(".rxm")||n.endsWith("01_MAIN.md")||n.endsWith("02_SUPPLEMENTARY_INFO.md");return e.languageId==="rxiv-markdown"||t}async validateDocument(e){if(this.isRxivMarkdownDocument(e))try{let n=[],t=B.parseDocument(e),s=await Promise.all(this.validators.map(i=>i.validate(e,t)));for(let i of s)n.push(...i);this.diagnosticCollection.set(e.uri,n)}catch(n){console.error("Error validating rxiv-markdown document:",n)}}async validateAllOpenDocuments(){let e=W.workspace.textDocuments.filter(n=>this.isRxivMarkdownDocument(n)).map(n=>this.validateDocument(n));await Promise.all(e)}clearAllDiagnostics(){this.diagnosticCollection.clear()}dispose(){this.diagnosticCollection.dispose(),this.disposables.forEach(e=>e.dispose()),this.disposables=[]}};var N=T(require("vscode"));var pe=require("child_process"),ue=require("util");var ve=(0,ue.promisify)(pe.exec);async function Y(){try{let{stdout:u}=await ve("which rxiv 2>/dev/null || where rxiv 2>nul"),e=u.trim();if(!e)return"unknown";let n=["/opt/homebrew","/usr/local","/home/linuxbrew/.linuxbrew"];for(let t of n)if(e.startsWith(t)&&(e.includes("/Cellar/")||e.includes("/opt/")))return"homebrew";return e.includes(".local/pipx/venvs/rxiv-maker")||e.includes(".local/share/pipx/venvs/rxiv-maker")?"pipx":e.includes(".local/share/uv/tools/rxiv-maker")?"uv":e.includes("/rxiv-maker/")&&(e.includes(".git")||e.includes("src/"))?"dev":e.includes(".local/lib/python")&&e.includes("site-packages")?"pip-user":e.includes("/site-packages/")||e.includes("/dist-packages/")?"pip":"unknown"}catch(u){return console.error("Error detecting install method:",u),"unknown"}}y(Y,"detectInstallMethod");function ge(u){return{homebrew:"brew update && brew upgrade rxiv-maker",pipx:"pipx upgrade rxiv-maker",uv:"uv tool upgrade rxiv-maker","pip-user":"pip install --upgrade --user rxiv-maker",pip:"pip install --upgrade rxiv-maker",dev:"cd <repo> && git pull && uv sync",unknown:"pip install --upgrade rxiv-maker"}[u]}y(ge,"getUpgradeCommand");function Q(u){return{homebrew:"Homebrew",pipx:"pipx",uv:"uv tool","pip-user":"pip (user)",pip:"pip",dev:"Development mode",unknown:"Unknown"}[u]}y(Q,"getFriendlyInstallName");async function J(){try{let{stdout:u}=await ve("rxiv --version 2>/dev/null || rxiv.exe --version 2>nul");return u.trim().length>0}catch{return!1}}y(J,"isRxivMakerInstalled");var he=require("child_process"),fe=require("util"),we=T(require("https")),xe=T(require("vscode"));var be=(0,fe.promisify)(he.exec);async function ee(){try{let{stdout:u}=await be("rxiv --version 2>/dev/null || rxiv.exe --version 2>nul"),e=u.trim().match(/(\d+\.\d+\.\d+)/);return e?e[1]:null}catch{return null}}y(ee,"getRxivMakerVersion");async function et(){try{let{stdout:u}=await be("brew outdated --verbose rxiv-maker 2>/dev/null");if(!u.trim())return null;let e=u.trim().match(/\(([0-9.]+)\)\s*<\s*([0-9.]+)/);return e?{current:e[1],latest:e[2]}:null}catch{return null}}y(et,"checkHomebrewOutdated");async function tt(){return new Promise(u=>{we.get("https://pypi.org/pypi/rxiv-maker/json",n=>{let t="";n.on("data",s=>{t+=s}),n.on("end",()=>{try{let s=JSON.parse(t);u(s.info.version)}catch(s){console.error("Error parsing PyPI response:",s),u(null)}})}).on("error",n=>{console.error("Error fetching latest version:",n),u(null)})})}y(tt,"fetchLatestVersion");function nt(u,e){let n=u.split(".").map(Number),t=e.split(".").map(Number);for(let s=0;s<Math.max(n.length,t.length);s++){let i=n[s]||0,o=t[s]||0;if(o>i)return!0;if(o<i)return!1}return!1}y(nt,"isNewerVersion");async function ce(u){let e=xe.workspace.getConfiguration("rxiv-maker");if(!e.get("checkForUpdates",!0))return{current:null,latest:null,updateAvailable:!1};let t="rxivMakerVersionCache",s=u.globalState.get(t);if(s){let m=new Date(s.lastCheck),f=(new Date().getTime()-m.getTime())/(1e3*60*60),x=e.get("updateCheckInterval",24);if(f<x)return{current:s.currentVersion,latest:s.latestVersion,updateAvailable:s.updateAvailable}}let i=await ee(),o=null,a=!1;if(await Y()==="homebrew"){let m=await et();m?(o=m.latest,a=!0):(o=i,a=!1)}else o=await tt(),a=i&&o?nt(i,o):!1;let d={lastCheck:new Date().toISOString(),latestVersion:o||"",currentVersion:i||"",updateAvailable:a};return await u.globalState.update(t,d),{current:i,latest:o,updateAvailable:a}}y(ce,"checkForUpdates");async function le(u){return await u.globalState.update("rxivMakerVersionCache",void 0),ce(u)}y(le,"forceCheckForUpdates");async function ye(u){if(!await J()){await N.window.showErrorMessage("rxiv-maker is not installed. Would you like to install it?","Install","Cancel")==="Install"&&N.commands.executeCommand("rxiv-maker.install");return}let n=await Y(),t=Q(n);if(n==="dev"){await N.window.showWarningMessage(`Development installation detected. To update, pull the latest changes from git:
cd <repo> && git pull && uv sync`,{modal:!0});return}await N.window.withProgress({location:N.ProgressLocation.Notification,title:"Checking for updates...",cancellable:!1},async()=>{let s=await le(u);if(!s.updateAvailable){N.window.showInformationMessage(`\u2705 You already have the latest version (${s.current})`);return}let i=ge(n),o=`\u{1F4E6} Update available: rxiv-maker v${s.current} \u2192 v${s.latest}
Installed via: ${t}
Upgrade command: ${i}`,a=await N.window.showInformationMessage(o,{modal:!0},"Run Upgrade Command","Copy to Clipboard","Later");if(a==="Run Upgrade Command"){let r=N.window.createTerminal("rxiv-maker upgrade");r.show(),r.sendText(i)}else a==="Copy to Clipboard"&&(await N.env.clipboard.writeText(i),N.window.showInformationMessage("Upgrade command copied to clipboard"))})}y(ye,"upgradeRxivMakerCommand");async function ke(u){if(!await J()){N.window.showInformationMessage("\u274C rxiv-maker is not installed");return}let n=await ee(),t=await Y(),s=Q(t),i=await le(u),o=`rxiv-maker v${n}
`;o+=`Installed via: ${s}
`,i.updateAvailable?o+=`\u26A0\uFE0F Update available: v${i.latest}`:o+="\u2705 Up to date",N.window.showInformationMessage(o)}y(ke,"showRxivMakerStatus");function st(u){console.log("Rxiv-Maker extension is now active!");let e=new ae;u.subscriptions.push(e);let n=new Map,t,s,i=y(()=>{t&&t.dispose(),l.workspace.getConfiguration("rxiv-maker").get("showStatusBarButton",!0)&&(t=l.window.createStatusBarItem(l.StatusBarAlignment.Left,100),t.command="rxiv-maker.makePdf",t.text="\u{1F4C4} rxiv PDF",t.tooltip="Build PDF with rxiv-maker",u.subscriptions.push(t))},"createStatusBarItem"),o=y(async()=>{s&&s.dispose(),s=l.window.createStatusBarItem(l.StatusBarAlignment.Right,100),s.command="rxiv-maker.upgrade",u.subscriptions.push(s),await a(),s.show()},"createVersionStatusBarItem"),a=y(async()=>{if(!s)return;if(!await J()){s.text="$(warning) rxiv-maker: Not installed",s.tooltip="Click to install rxiv-maker",s.command="rxiv-maker.installRxivMaker";return}let g=await ee(),w=await Y(),h=Q(w),p=await ce(u);p.updateAvailable?(s.text=`$(arrow-up) rxiv-maker: v${g} \u2192 v${p.latest}`,s.tooltip=`Update available! Click to upgrade
Installed via: ${h}`,s.command="rxiv-maker.upgrade"):(s.text=`$(check) rxiv-maker: v${g}`,s.tooltip=`Up to date
Installed via: ${h}`,s.command="rxiv-maker.showStatus")},"updateVersionStatusBar"),r=y(async c=>{if(!t)return;if(c||(c=l.window.activeTextEditor?.document),!c){t.hide();return}let g=S.basename(c.fileName);if(c.fileName.endsWith(".rxm")||g==="01_MAIN.md"||g==="02_SUPPLEMENTARY_INFO.md"||c.languageId==="rxiv-markdown"){let h=l.workspace.getWorkspaceFolder(c.uri);if(h){let p=h.uri.fsPath,C=n.get(p);C===void 0&&(C=await de(p),n.set(p,C)),C?t.show():t.hide()}else t.hide()}else t.hide()},"updateStatusBarVisibility");i(),o(),l.window.onDidChangeActiveTextEditor(c=>{r(c?.document)},null,u.subscriptions),l.workspace.onDidOpenTextDocument(r,null,u.subscriptions),l.workspace.onDidChangeConfiguration(c=>{c.affectsConfiguration("rxiv-maker.showStatusBarButton")&&(i(),r())},null,u.subscriptions);let d=l.workspace.onDidOpenTextDocument(async c=>{let g=S.basename(c.fileName);if(c.fileName.endsWith(".rxm")||g==="01_MAIN.md"||g==="02_SUPPLEMENTARY_INFO.md"){let h=l.workspace.getWorkspaceFolder(c.uri);if(h){let p=h.uri.fsPath,C=n.get(p);C===void 0&&(C=await de(p),n.set(p,C)),C&&(await l.languages.setTextDocumentLanguage(c,"rxiv-markdown"),await e.validateDocument(c),await r(c))}}});setTimeout(async()=>{for(let c of l.workspace.textDocuments){let g=S.basename(c.fileName);if(c.fileName.endsWith(".rxm")||g==="01_MAIN.md"||g==="02_SUPPLEMENTARY_INFO.md"){let h=l.workspace.getWorkspaceFolder(c.uri);if(h){let p=h.uri.fsPath,C=n.get(p);C===void 0&&(C=await de(p),n.set(p,C)),C&&(await l.languages.setTextDocumentLanguage(c,"rxiv-markdown"),await e.validateDocument(c),await r(c))}}}},500);let m=l.languages.registerCompletionItemProvider({language:"rxiv-markdown"},{async provideCompletionItems(c,g){return c.lineAt(g).text.substr(0,g.character).endsWith("@")?(await Ce()).map(p=>{let C=new l.CompletionItem(p.key,l.CompletionItemKind.Reference);return C.detail=p.title||p.type,C.documentation=p.author||"",C.insertText=p.key,C}):[]}},"@"),v=l.languages.registerCompletionItemProvider({language:"rxiv-markdown"},{async provideCompletionItems(c,g){return c.lineAt(g).text.substr(0,g.character).endsWith("@")?(await re()).map(p=>{let C=p.supplementary?`s${p.type}:`:`${p.type}:`,R=new l.CompletionItem(`${C}${p.label}`,l.CompletionItemKind.Reference);return R.detail=`${p.type.toUpperCase()} reference`,R.documentation=`Line ${p.line+1}${p.supplementary?" (Supplementary)":""}`,R.insertText=`${C}${p.label}`,R}):[]}},"@"),f=l.commands.registerCommand("rxiv-maker.insertCitation",async()=>{let c=await Ce();if(c.length===0){let h=[],p=l.window.activeTextEditor;if(p){let R=S.dirname(p.document.fileName);h.push(S.join(R,"03_REFERENCES.bib"))}if(l.workspace.workspaceFolders)for(let R of l.workspace.workspaceFolders){let V=S.join(R.uri.fsPath,"03_REFERENCES.bib");h.includes(V)||h.push(V)}let C=`No bibliography file (03_REFERENCES.bib) found.

Searched in:
${h.join(`
`)}

Please create 03_REFERENCES.bib in the same directory as your document.`;l.window.showWarningMessage(C);return}let g=c.map(h=>({label:h.key,description:h.title||h.type,detail:h.author||""})),w=await l.window.showQuickPick(g,{placeHolder:"Select citation to insert"});if(w){let h=l.window.activeTextEditor;if(h){let p=h.selection.active;await h.edit(C=>{C.insert(p,`@${w.label}`)})}}}),x=l.commands.registerCommand("rxiv-maker.insertFigureReference",async()=>{let g=(await re()).filter(p=>p.type==="fig");if(g.length===0){l.window.showWarningMessage("No figure labels found in the document");return}let w=g.map(p=>({label:p.label,description:p.supplementary?"Supplementary Figure":"Figure",detail:`Line ${p.line+1}`})),h=await l.window.showQuickPick(w,{placeHolder:"Select figure reference to insert"});if(h){let p=l.window.activeTextEditor;if(p){let C=p.selection.active,R=g.find(V=>V.label===h.label)?.supplementary?"@sfig:":"@fig:";await p.edit(V=>{V.insert(C,`${R}${h.label}`)})}}}),k=l.commands.registerCommand("rxiv-maker.insertTableReference",async()=>{let g=(await re()).filter(p=>p.type==="table");if(g.length===0){l.window.showWarningMessage("No table labels found in the document");return}let w=g.map(p=>({label:p.label,description:p.supplementary?"Supplementary Table":"Table",detail:`Line ${p.line+1}`})),h=await l.window.showQuickPick(w,{placeHolder:"Select table reference to insert"});if(h){let p=l.window.activeTextEditor;if(p){let C=p.selection.active,R=g.find(V=>V.label===h.label)?.supplementary?"@stable:":"@table:";await p.edit(V=>{V.insert(C,`${R}${h.label}`)})}}}),D=l.commands.registerCommand("rxiv-maker.insertEquationReference",async()=>{let g=(await re()).filter(p=>p.type==="eq");if(g.length===0){l.window.showWarningMessage("No equation labels found in the document");return}let w=g.map(p=>({label:p.label,description:"Equation",detail:`Line ${p.line+1}`})),h=await l.window.showQuickPick(w,{placeHolder:"Select equation reference to insert"});if(h){let p=l.window.activeTextEditor;if(p){let C=p.selection.active;await p.edit(R=>{R.insert(C,`@eq:${h.label}`)})}}}),I=new Map,A=y(c=>{let g=I.get(c);if(g&&g.exitStatus===void 0)return g;let w=`rxiv-maker: ${S.basename(c)||c}`,h=l.window.createTerminal({name:w,cwd:c});return I.set(c,h),l.window.onDidCloseTerminal(p=>{for(let[C,R]of I.entries())if(R===p){I.delete(C);break}}),h},"getRxivMakerTerminal"),O=l.commands.registerCommand("rxiv-maker.makeValidate",async()=>{let c=await K();if(!c.success||!c.manuscriptPath){l.window.showErrorMessage(c.error||"Could not determine manuscript folder");return}let g=A(c.manuscriptPath);g.show(),g.sendText("rxiv validate .")}),M=l.commands.registerCommand("rxiv-maker.makePdf",async()=>{let c=await K();if(!c.success||!c.manuscriptPath){l.window.showErrorMessage(c.error||"Could not determine manuscript folder");return}let g=A(c.manuscriptPath);g.show(),g.sendText("rxiv pdf .")}),$=l.commands.registerCommand("rxiv-maker.makeDocx",async()=>{let c=await K();if(!c.success||!c.manuscriptPath){l.window.showErrorMessage(c.error||"Could not determine manuscript folder");return}let g=A(c.manuscriptPath);g.show(),g.sendText("rxiv docx .")}),rt=l.commands.registerCommand("rxiv-maker.resolveInlineDois",async()=>{let c=await K();if(!c.success||!c.manuscriptPath){l.window.showErrorMessage(c.error||"Could not determine manuscript folder");return}let g=A(c.manuscriptPath);g.show(),g.sendText("rxiv docx --resolve-dois .")}),Pe=l.commands.registerCommand("rxiv-maker.makeClean",async()=>{let c=await K();if(!c.success||!c.manuscriptPath){l.window.showErrorMessage(c.error||"Could not determine manuscript folder");return}let g=A(c.manuscriptPath);g.show(),g.sendText("rxiv clean .")}),Ee=l.commands.registerCommand("rxiv-maker.installRxivMaker",async()=>{await l.window.withProgress({location:l.ProgressLocation.Notification,title:"Checking installation prerequisites...",cancellable:!1},async c=>{c.report({increment:50,message:"Checking pipx availability..."});let g=!1;try{await new Promise((p,C)=>{(0,De.exec)("pipx --version",{timeout:5e3},(R,V,ct)=>{R||(g=!0),p()})})}catch{}if(!g){if(await l.window.showWarningMessage("pipx is required to install rxiv-maker. Would you like to see installation instructions?",{modal:!0},"Show Installation Instructions","Cancel")==="Show Installation Instructions"){let R=await l.workspace.openTextDocument({content:"# Install pipx (Python Package Manager)\n\n## macOS:\n```bash\nbrew install pipx\n```\n\n## Linux (Ubuntu/Debian):\n```bash\nsudo apt update\nsudo apt install pipx\n```\n\n## Linux (Other):\n```bash\npython3 -m pip install --user pipx\npython3 -m pipx ensurepath\n```\n\n## Windows:\n```powershell\npip install --user pipx\n```\n\nAfter installing pipx, restart VS Code and try again.",language:"markdown"});await l.window.showTextDocument(R)}return}if(await l.window.showInformationMessage("Install rxiv-maker using pipx? This will install rxiv-maker globally and make it available from any terminal.",{modal:!0},"Yes, install rxiv-maker","No, cancel")!=="Yes, install rxiv-maker")return;let h=l.window.createTerminal({name:"rxiv-maker-install"});h.show(),h.sendText('echo "Installing rxiv-maker with pipx..."'),h.sendText("pipx install rxiv-maker"),h.sendText('echo "Installation complete! You can now use rxiv commands."'),h.sendText("rxiv --version")})}),Ie=l.commands.registerCommand("rxiv-maker.upgrade",async()=>{await ye(u),await a()}),Se=l.commands.registerCommand("rxiv-maker.showStatus",async()=>{await ke(u)}),Re=l.commands.registerCommand("rxiv-maker.makeAddBibliography",async()=>{let c=await K();if(!c.success||!c.manuscriptPath){l.window.showErrorMessage(c.error||"Could not determine manuscript folder");return}let g=await l.window.showInputBox({prompt:"Enter DOI to add to bibliography",placeHolder:"e.g., 10.1000/example or https://doi.org/10.1000/example",validateInput:y(p=>{if(!p)return"DOI is required";if(!/^(https?:\/\/)?(dx\.)?doi\.org\/10\.|^10\./.test(p))return"Please enter a valid DOI (e.g., 10.1000/example)"},"validateInput")});if(!g)return;let w=g.replace(/^(https?:\/\/)?(dx\.)?doi\.org\//,""),h=A(c.manuscriptPath);h.show(),h.sendText(`rxiv bibliography add --manuscript-path . ${w}`)}),Me=l.commands.registerCommand("rxiv-maker.insertBlindtext",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active;await c.edit(w=>{w.insert(g,"{{blindtext}}")})}}),Te=l.commands.registerCommand("rxiv-maker.insertBlindtextParagraph",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active;await c.edit(w=>{w.insert(g,"{{Blindtext}}")})}}),Ae=l.commands.registerCommand("rxiv-maker.insertPythonBlock",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=c.selection;if(w.isEmpty){let h=new l.SnippetString(`{{py:
$1
}}`);await c.insertSnippet(h,g)}else{let h=c.document.getText(w);await c.edit(p=>{p.replace(w,`{{py:
${h}
}}`)})}}}),$e=l.commands.registerCommand("rxiv-maker.insertPythonInline",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=c.selection;if(w.isEmpty){let h=new l.SnippetString("{py: $1}");await c.insertSnippet(h,g)}else{let h=c.document.getText(w);await c.edit(p=>{p.replace(w,`{py: ${h}}`)})}}}),_e=l.commands.registerCommand("rxiv-maker.insertPythonImport",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=[{label:"datetime",detail:"Date and time operations"},{label:"math",detail:"Mathematical functions"},{label:"statistics",detail:"Statistical functions"},{label:"json",detail:"JSON encoder/decoder"},{label:"csv",detail:"CSV file reading/writing"},{label:"random",detail:"Generate random numbers"},{label:"collections",detail:"Specialized container datatypes"},{label:"itertools",detail:"Iterator building blocks"},{label:"functools",detail:"Higher-order functions and operations on functions"}],h=await l.window.showQuickPick(w,{placeHolder:"Select a module to import (or type a custom module name)"});if(h){let p=new l.SnippetString(`{py:import ${h.label}}`);await c.insertSnippet(p,g)}else{let p=await l.window.showInputBox({prompt:"Enter module name to import",placeHolder:"e.g., datetime"});if(p){let C=new l.SnippetString(`{py:import ${p}}`);await c.insertSnippet(C,g)}}}}),Fe=l.commands.registerCommand("rxiv-maker.insertPythonFromImport",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=new l.SnippetString("{py:from ${1:module} import ${2:item}}");await c.insertSnippet(w,g)}}),Ne=l.commands.registerCommand("rxiv-maker.insertPythonSet",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=new l.SnippetString('{py:set ${1:variable_name} = ${2:"value"}}');await c.insertSnippet(w,g)}}),Le=l.commands.registerCommand("rxiv-maker.insertPythonGet",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=new l.SnippetString("{py:get ${1:variable_name}}");await c.insertSnippet(w,g)}}),Be=l.commands.registerCommand("rxiv-maker.insertPythonContext",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=new l.SnippetString('{py:context="${1:context_name}" ${2:code}}');await c.insertSnippet(w,g)}}),Oe=l.commands.registerCommand("rxiv-maker.insertPythonFormat",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=[{label:"number,2",detail:"Format number with 2 decimal places"},{label:"percentage,1",detail:"Format as percentage with 1 decimal place"},{label:"currency",detail:"Format as currency"},{label:"scientific,3",detail:"Format in scientific notation with 3 decimal places"},{label:"date,%Y-%m-%d",detail:"Format date as YYYY-MM-DD"},{label:"date,%B %d, %Y",detail:'Format date as "Month DD, YYYY"'},{label:"comma",detail:"Add thousand separators"}],h=await l.window.showQuickPick(w,{placeHolder:"Select a format specification"});if(h){let p=new l.SnippetString(`{py:format="${h.label}" \${1:expression}}`);await c.insertSnippet(p,g)}else{let p=new l.SnippetString('{py:format="${1:format_spec}" ${2:expression}}');await c.insertSnippet(p,g)}}}),Ue=l.commands.registerCommand("rxiv-maker.insertPythonGlobal",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=new l.SnippetString('{py:global ${1:variable_name} = ${2:"value"}}');await c.insertSnippet(w,g)}}),Ve=l.commands.registerCommand("rxiv-maker.insertPythonIf",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=new l.SnippetString('{py:if ${1:condition}: "${2:true_value}" else: "${3:false_value}"}');await c.insertSnippet(w,g)}}),je=l.commands.registerCommand("rxiv-maker.insertTexBlock",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=c.selection;if(w.isEmpty){let h=new l.SnippetString(`{{tex:
$1
}}`);await c.insertSnippet(h,g)}else{let h=c.document.getText(w);await c.edit(p=>{p.replace(w,`{{tex:
${h}
}}`)})}}}),ze=l.commands.registerCommand("rxiv-maker.insertTexInline",async()=>{let c=l.window.activeTextEditor;if(c){let g=c.selection.active,w=c.selection;if(w.isEmpty){let h=new l.SnippetString("{{tex: $1}}");await c.insertSnippet(h,g)}else{let h=c.document.getText(w);await c.edit(p=>{p.replace(w,`{{tex: ${h}}}`)})}}}),Ze=l.commands.registerCommand("rxiv-maker.validateDocument",async()=>{let c=l.window.activeTextEditor;c?(await e.validateDocument(c.document),l.window.showInformationMessage("Document validation completed")):l.window.showWarningMessage("No active document to validate")}),We=l.commands.registerCommand("rxiv-maker.clearDiagnostics",()=>{e.clearAllDiagnostics(),l.window.showInformationMessage("All diagnostics cleared")}),qe=l.commands.registerCommand("rxiv-maker.validateAllDocuments",async()=>{await e.validateAllOpenDocuments(),l.window.showInformationMessage("All documents validated")});u.subscriptions.push(d,m,v,f,x,k,D,Ee,Ie,Se,O,M,Pe,Re,Me,Te,Ae,$e,_e,Fe,Ne,Le,Be,Oe,Ue,Ve,je,ze,Ze,We,qe)}y(st,"activate");async function Ce(){let u=[],e=l.window.activeTextEditor;if(e){let t=S.dirname(e.document.fileName),s=S.join(t,"03_REFERENCES.bib");u.push(s),console.log("Rxiv-Maker: Searching for bibliography in current document directory:",s)}if(l.workspace.workspaceFolders)for(let t of l.workspace.workspaceFolders){let s=S.join(t.uri.fsPath,"03_REFERENCES.bib");u.includes(s)||(u.push(s),console.log("Rxiv-Maker: Searching for bibliography in workspace folder:",s))}let n=null;for(let t of u)try{await z.promises.access(t,z.constants.F_OK|z.constants.R_OK),n=t,console.log("Rxiv-Maker: Found bibliography file at:",n);break}catch{console.log("Rxiv-Maker: Bibliography not found at:",t)}if(!n)return console.log("Rxiv-Maker: No bibliography file found in any search location"),[];try{let t=await z.promises.readFile(n,"utf8"),s=[],i=/@(\w+)\s*\{\s*([^,\s]+)\s*,/g,o;for(;(o=i.exec(t))!==null;){let a=o[1],r=o[2],d=o.index,m=it(t,d),v=t.substring(d,m),f=v.match(/title\s*=\s*[{"](.*?)["}]/),x=v.match(/author\s*=\s*[{"](.*?)["}]/),k=v.match(/year\s*=\s*[{"](.*?)["}]/);s.push({key:r,type:a,title:f?.[1],author:x?.[1],year:k?.[1]})}return s}catch(t){return t.code==="ENOENT"?[]:(console.error("Error parsing bibliography:",t),[])}}y(Ce,"getBibEntries");async function re(){let u=[],e=[],n=l.window.activeTextEditor;if(n){let t=S.dirname(n.document.fileName);e.push(S.join(t,"01_MAIN.md")),e.push(S.join(t,"02_SUPPLEMENTARY_INFO.md"))}if(l.workspace.workspaceFolders)for(let t of l.workspace.workspaceFolders){let s=S.join(t.uri.fsPath,"01_MAIN.md"),i=S.join(t.uri.fsPath,"02_SUPPLEMENTARY_INFO.md");e.includes(s)||e.push(s),e.includes(i)||e.push(i)}for(let t of e)try{let i=(await z.promises.readFile(t,"utf8")).split(`
`),o=t.includes("02_SUPPLEMENTARY_INFO");for(let a=0;a<i.length;a++){let r=i[a],d=/\{#(s?)((fig|table|eq|snote)):([a-zA-Z0-9_-]+)(?:\s[^}]*)?\}/g,m;for(;(m=d.exec(r))!==null;){let v=m[1]==="s"||o,f=m[2],x=m[4];u.push({type:f,label:x,line:a,supplementary:v})}}}catch{continue}return u}y(re,"getDocumentReferences");function it(u,e){let n=0,t=!1,s="";for(let i=e;i<u.length;i++){let o=u[i];if(t)o===s&&u[i-1]!=="\\"&&(t=!1);else if(o==='"'||o==="'")t=!0,s=o;else if(o==="{")n++;else if(o==="}"&&(n--,n===0))return i+1}return u.length}y(it,"findMatchingBrace");async function de(u){try{let e=["00_CONFIG.yml","01_MAIN.rxm","01_MAIN.md","03_REFERENCES.bib"],n=["02_SUPPLEMENTARY_INFO.rxm","02_SUPPLEMENTARY_INFO.md"];return(await Promise.all(e.map(async i=>{try{return await z.promises.access(S.join(u,i)),!0}catch{return!1}}))).filter(Boolean).length>=2}catch(e){return console.error("Error checking rxiv-maker project:",e),!1}}y(de,"isRxivMakerProject");async function K(){let u=l.window.activeTextEditor;if(!u)return{success:!1,error:"No active document. Please open a file in your manuscript folder."};let e=u.document.fileName,n=S.dirname(e),t=["00_CONFIG.yml","01_MAIN.md","01_MAIN.rxm","03_REFERENCES.bib"],s=await Promise.all(t.map(async o=>{try{return await z.promises.access(S.join(n,o)),!0}catch{return!1}})),i;if(s.some(o=>o))i=n;else{let o=l.workspace.workspaceFolders;if(!o)return{success:!1,error:"No workspace folder found. Please open the manuscript folder in VS Code."};let a=null;for(let r of o){let d=r.uri.fsPath;if((await Promise.all(t.map(async v=>{try{return await z.promises.access(S.join(d,v)),!0}catch{return!1}}))).some(v=>v)){a=d;break}}if(!a)return{success:!1,error:"No manuscript folder found. Please ensure your workspace contains a folder with rxiv-maker files (00_CONFIG.yml, 01_MAIN.md, etc.)"};i=a}return{success:!0,manuscriptPath:i}}y(K,"findManuscriptFolder");function ot(){}y(ot,"deactivate");0&&(module.exports={activate,deactivate});
